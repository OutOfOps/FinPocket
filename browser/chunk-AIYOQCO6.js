import{a as l,b as g,i as b,k as p,l as j,w as y}from"./chunk-X6DWFC4Y.js";var h=class m{typeOptionsInternal=[{type:"water",label:"\u0412\u043E\u0434\u0430",unit:"\u043C\xB3",icon:"water_drop",description:"\u0425\u043E\u043B\u043E\u0434\u043D\u0430\u044F \u0438 \u0433\u043E\u0440\u044F\u0447\u0430\u044F \u0432\u043E\u0434\u0430"},{type:"gas",label:"\u0413\u0430\u0437",unit:"\u043C\xB3",icon:"local_fire_department",description:"\u041F\u0440\u0438\u0440\u043E\u0434\u043D\u044B\u0439 \u0433\u0430\u0437 \u0438 \u0442\u043E\u043F\u043B\u0438\u0432\u043E"},{type:"electricity",label:"\u042D\u043B\u0435\u043A\u0442\u0440\u0438\u0447\u0435\u0441\u0442\u0432\u043E",unit:"\u043A\u0412\u0442\xB7\u0447",icon:"bolt",description:"\u0423\u0447\u0451\u0442 \u044D\u043B\u0435\u043A\u0442\u0440\u043E\u044D\u043D\u0435\u0440\u0433\u0438\u0438 \u043F\u043E \u0437\u043E\u043D\u0430\u043C"},{type:"heat",label:"\u041E\u0442\u043E\u043F\u043B\u0435\u043D\u0438\u0435",unit:"\u0413\u043A\u0430\u043B",icon:"device_thermostat",description:"\u0426\u0435\u043D\u0442\u0440\u0430\u043B\u044C\u043D\u043E\u0435 \u043E\u0442\u043E\u043F\u043B\u0435\u043D\u0438\u0435 \u0438 \u0442\u0435\u043F\u043B\u043E"},{type:"service",label:"\u0423\u0441\u043B\u0443\u0433\u0430",unit:"UAH",icon:"miscellaneous_services",description:"\u0424\u0438\u043A\u0441\u0438\u0440\u043E\u0432\u0430\u043D\u043D\u044B\u0435 \u043F\u043B\u0430\u0442\u0435\u0436\u0438 \u0431\u0435\u0437 \u043F\u043E\u043A\u0430\u0437\u0430\u043D\u0438\u0439"}];objectsSubject=new b([]);resourcesSubject=new b([]);tariffsSubject=new b([]);readingsSubject=new b([]);objects$=this.objectsSubject.asObservable();resources$=this.resourcesSubject.asObservable();tariffs$=this.tariffsSubject.asObservable();readings$=this.readingsSubject.asObservable();typeOptions=this.typeOptionsInternal;objectOptions$=this.objects$.pipe(p(e=>e.map(t=>t.name)));readingList$=j([this.readings$,this.resources$,this.objects$,this.tariffs$]).pipe(p(([e,t,r,i])=>e.slice().sort((n,s)=>s.submittedAt.localeCompare(n.submittedAt)).map(n=>{let s=t.find(d=>d.id===n.resourceId),o=r.find(d=>d.id===n.objectId);if(!s||!o)throw new Error("Reading references unknown object or resource");let u=this.getPreviousReading(s.id,n.id),f=this.calculateConsumption(n,u),{cost:c,currency:a}=this.calculateCost(s,f,i,n.submittedAt);return{id:n.id,objectName:o.name,resourceId:s.id,resourceName:s.name,type:s.type,typeLabel:this.typeLabel(s.type),submittedAt:n.submittedAt,unit:s.unit,zones:s.zones.map(d=>({id:d.id,label:d.name,value:this.getZoneValue(n.values,d.id),previous:u?this.getZoneValue(u.values,d.id):null,consumption:f.get(d.id)??0})),cost:c,currency:a}})));getDefaultObjectId(){return this.objectsSubject.value[0]?.id}reset(){this.objectsSubject.next([]),this.resourcesSubject.next([]),this.tariffsSubject.next([]),this.readingsSubject.next([])}typeLabel(e){return this.typeOptionsInternal.find(t=>t.type===e)?.label??e}typeIcon(e){return this.typeOptionsInternal.find(t=>t.type===e)?.icon??"category"}typeDescription(e){return this.typeOptionsInternal.find(t=>t.type===e)?.description??""}getObjectById(e){return this.objectsSubject.value.find(t=>t.id===e)}getObjectByName(e){return this.objectsSubject.value.find(t=>t.name===e.trim())}ensureObject(e){let t=e.trim();if(!t)throw new Error("Object name cannot be empty");let r=this.getObjectByName(t);if(r)return r;let i={id:this.generateId("OBJ"),name:t};return this.objectsSubject.next([...this.objectsSubject.value,i]),i}getResourcesForObject(e){return this.resourcesSubject.value.filter(t=>t.objectId===e)}getResourceById(e){return this.resourcesSubject.value.find(t=>t.id===e)}getReadingById(e){return this.readingsSubject.value.find(t=>t.id===e)}getReadingsForResource(e){return this.readingsSubject.value.filter(t=>t.resourceId===e).sort((t,r)=>r.submittedAt.localeCompare(t.submittedAt))}getResourceSummary(e){let t=this.getResourceById(e);if(!t)return;let r=this.getObjectById(t.objectId);if(!r)return;let i=this.getActiveTariffs(t.id,new Date().toISOString().slice(0,10));return{resource:t,object:r,currentTariffs:i}}getTariffHistory(e){return this.tariffsSubject.value.filter(t=>t.resourceId===e).sort((t,r)=>r.effectiveFrom.localeCompare(t.effectiveFrom))}getPreviousReading(e,t){return this.readingsSubject.value.filter(r=>r.resourceId===e&&r.id!==t).sort((r,i)=>i.submittedAt.localeCompare(r.submittedAt))[0]}getPreviousReadingBefore(e,t,r){return this.readingsSubject.value.filter(i=>i.resourceId===e&&i.id!==r&&i.submittedAt<=t).sort((i,n)=>n.submittedAt.localeCompare(i.submittedAt))[0]}estimatePeriodSummary(e,t,r,i){let n=this.getResourceById(e);if(!n)return{previous:void 0,consumption:new Map};let s=this.getPreviousReadingBefore(e,r,i),o={id:i??"TEMP",objectId:n.objectId,resourceId:e,submittedAt:r,values:t},u=this.calculateConsumption(o,s),{cost:f,currency:c}=this.calculateCost(n,u,this.tariffsSubject.value,r);return{previous:s,consumption:u,cost:f,currency:c}}upsertReading(e){let t=[...this.readingsSubject.value],r=e.values.map(n=>({zoneId:n.zoneId,value:Number(n.value??0)}));if(e.id){let n=t.findIndex(s=>s.id===e.id);if(Number.isInteger(n)&&n>=0&&n<t.length){let s=g(l({},t[n]),{objectId:e.objectId,resourceId:e.resourceId,submittedAt:e.submittedAt,values:r});return t[n]=s,this.readingsSubject.next(this.sortReadings(t)),s}}let i={id:this.generateId("MTR"),objectId:e.objectId,resourceId:e.resourceId,submittedAt:e.submittedAt,values:r};return t.push(i),this.readingsSubject.next(this.sortReadings(t)),i}upsertResource(e){let t=this.ensureObject(e.objectName),r=e.zones.length?e.zones:[{id:"total",name:"\u041E\u0431\u0449\u0438\u0439 \u0441\u0447\u0451\u0442\u0447\u0438\u043A"}],i=[...this.resourcesSubject.value];if(e.id){let s=i.findIndex(o=>o.id===e.id);if(Number.isInteger(s)&&s>=0&&s<i.length){let o=g(l({},i[s]),{objectId:t.id,type:e.type,name:e.name.trim(),unit:e.unit,pricingModel:e.pricingModel,zones:r,fixedAmount:e.fixedAmount,fixedCurrency:e.fixedCurrency});return Number.isInteger(s)&&s>=0&&s<i.length&&(i[s]=o),this.resourcesSubject.next(i),o}}let n={id:this.generateId("RES"),objectId:t.id,type:e.type,name:e.name.trim(),unit:e.unit,pricingModel:e.pricingModel,zones:r,fixedAmount:e.fixedAmount,fixedCurrency:e.fixedCurrency};return i.push(n),this.resourcesSubject.next(i),n}deleteResource(e){let t=this.resourcesSubject.value.filter(r=>r.id!==e);this.resourcesSubject.next(t),this.readingsSubject.next(this.readingsSubject.value.filter(r=>r.resourceId!==e)),this.tariffsSubject.next(this.tariffsSubject.value.filter(r=>r.resourceId!==e))}addTariff(e){let t=g(l({},e),{id:this.generateId("TRF")});return this.tariffsSubject.next([...this.tariffsSubject.value,t]),t}removeTariff(e){this.tariffsSubject.next(this.tariffsSubject.value.filter(t=>t.id!==e))}getActiveTariffs(e,t){let r=this.getResourceById(e);if(!r)return[];let i=this.tariffsSubject.value.filter(o=>o.resourceId===e&&o.effectiveFrom<=t).sort((o,u)=>u.effectiveFrom.localeCompare(o.effectiveFrom)),n=[],s=i.find(o=>!o.zoneId);s&&n.push(s);for(let o of r.zones){let u=i.find(f=>f.zoneId===o.id);u&&n.push(u)}return n}calculateConsumption(e,t){let r=new Map;for(let i of e.values){let n=t?.values.find(s=>s.zoneId===i.zoneId)?.value??0;r.set(i.zoneId,Math.max(0,Number(i.value)-Number(n)))}return r}getZoneValue(e,t){return e.find(r=>r.zoneId===t)?.value??0}calculateCost(e,t,r,i){let n=r.filter(c=>c.resourceId===e.id&&c.effectiveFrom<=i).sort((c,a)=>a.effectiveFrom.localeCompare(c.effectiveFrom));if(e.pricingModel==="fixed"){if(e.fixedAmount!==void 0)return{cost:e.fixedAmount,currency:e.fixedCurrency??e.unit};let c=n.find(a=>!a.zoneId);return c?{cost:c.price,currency:c.currency}:{cost:void 0,currency:void 0}}let s=0,o,u=n.find(c=>!c.zoneId);if(u)return o=u.currency,s=[...t.values()].reduce((c,a)=>c+a,0)*u.price,{cost:Number(s.toFixed(2)),currency:o};let f=!1;for(let c of e.zones){let a=n.find(d=>d.zoneId===c.id);a&&(f=!0,o=a.currency,s+=(t.get(c.id)??0)*a.price)}return f?{cost:Number(s.toFixed(2)),currency:o}:{cost:void 0,currency:void 0}}sortReadings(e){return e.sort((t,r)=>r.submittedAt.localeCompare(t.submittedAt))}generateId(e){let t=Math.floor(Math.random()*1e3).toString().padStart(3,"0"),r=Date.now().toString(36).toUpperCase();return`${e}-${r}-${t}`}static \u0275fac=function(t){return new(t||m)};static \u0275prov=y({token:m,factory:m.\u0275fac,providedIn:"root"})};export{h as a};
