import{a as u}from"./chunk-KX7B4REP.js";import{f as r,w as y,z as d}from"./chunk-X6DWFC4Y.js";var A=200,f=1e4,l=10,p=class o{constructor(i){this.db=i}isProcessing=!1;append(i){return r(this,null,function*(){let t={entityType:i.entityType,entityId:i.entityId,action:i.action,payload:i.payload,createdAt:new Date().toISOString(),retryCount:0};return yield this.db.syncQueue.add(t)})}flush(i){return r(this,null,function*(){if(!this.isProcessing){this.isProcessing=!0;try{let t=yield this.db.syncQueue.where("syncedAt").equals(void 0).filter(e=>{if(!e.nextRetryAt)return!0;let n=new Date(e.nextRetryAt);return!Number.isNaN(n.getTime())&&n.getTime()<=Date.now()}).toArray();for(let e of t){let n={id:e.id,entityType:e.entityType,entityId:e.entityId,action:e.action,payload:e.payload,createdAt:e.createdAt,syncedAt:e.syncedAt,retryCount:e.retryCount,nextRetryAt:e.nextRetryAt};try{yield i(n),n.id&&(yield this.db.syncQueue.update(n.id,{syncedAt:new Date().toISOString(),retryCount:0,nextRetryAt:void 0}))}catch(c){if(c?.status===401||c?.code===401)throw console.warn("Sync operation failed with 401, canceling queue"),new Error("Authentication required");let a=(n.retryCount||0)+1;if(a>=l){console.error("Max retry count reached, removing operation",n),n.id&&(yield this.db.syncQueue.delete(n.id));continue}let s=Math.min(A*Math.pow(2,a-1),f);console.warn(`Sync operation failed, retrying in ${s}ms (attempt ${a})`,c),n.id&&(yield this.db.syncQueue.update(n.id,{retryCount:a,nextRetryAt:new Date(Date.now()+s).toISOString()}))}}}finally{this.isProcessing=!1}}})}clear(){return r(this,null,function*(){yield this.db.syncQueue.clear()})}getPending(){return r(this,null,function*(){return(yield this.db.syncQueue.where("syncedAt").equals(void 0).toArray()).map(t=>({id:t.id,entityType:t.entityType,entityId:t.entityId,action:t.action,payload:t.payload,createdAt:t.createdAt,syncedAt:t.syncedAt,retryCount:t.retryCount,nextRetryAt:t.nextRetryAt}))})}static \u0275fac=function(t){return new(t||o)(d(u))};static \u0275prov=y({token:o,factory:o.\u0275fac,providedIn:"root"})};export{p as a};
