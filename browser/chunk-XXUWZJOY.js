import{J as o,Ua as l,Va as d,a as s,w as f}from"./chunk-X6DWFC4Y.js";var y=class u{storageKey="finpocket-currencies";defaultStorageKey="finpocket-default-currency";currenciesSignal=o(this.loadCurrencies());defaultCurrencySignal=o(this.loadDefaultCurrency(this.currenciesSignal()));currencies=this.currenciesSignal.asReadonly();defaultCurrency=this.defaultCurrencySignal.asReadonly();defaultCurrencyDetails=l(()=>{let e=this.currenciesSignal();if(!e.length)return null;let r=this.defaultCurrencySignal();return e.find(t=>t.id===r)??e[0]});currencyMap=l(()=>{let e=new Map;for(let r of this.currenciesSignal())e.set(r.code,r);return e});constructor(){this.ensureDefaultCurrency(this.currenciesSignal()),d(()=>{let e=this.currenciesSignal();this.persistCurrencies(e),this.ensureDefaultCurrency(e)}),d(()=>{this.persistDefaultCurrency(this.defaultCurrencySignal())})}addCurrency(e){let r=e.name.trim(),t=e.code.trim().toUpperCase(),n=this.normalizeRate(e.rateToBase);if(!r||!t||n===null)return;let a=this.generateId(t);this.currenciesSignal.update(i=>[...i,{id:a,name:r,code:t,rateToBase:n}])}updateCurrency(e,r){let t=r.name!==void 0?r.name.trim():void 0,n=r.code!==void 0?r.code.trim().toUpperCase():void 0,a;if(r.rateToBase!==void 0){let i=this.normalizeRate(r.rateToBase);if(i===null)return;a=i}t===""||n===""||this.currenciesSignal.update(i=>i.map(c=>c.id===e?s(s(s(s({},c),t!==void 0?{name:t}:{}),n!==void 0?{code:n}:{}),a!==void 0?{rateToBase:a}:{}):c))}removeCurrency(e){this.defaultCurrencySignal()!==e&&this.currenciesSignal.update(r=>r.filter(t=>t.id!==e))}setDefaultCurrency(e){this.defaultCurrencySignal()===e||!this.currenciesSignal().some(t=>t.id===e)||this.defaultCurrencySignal.set(e)}normalizeCode(e){let r=e.trim();if(!r)return this.getDefaultCurrencyCode();let t=r.toUpperCase();switch(t){case"\u20B4":case"\u0413\u0420\u041D":case"\u0413\u0420\u0418\u0412\u041D\u0410":return"UAH";case"$":case"\u0414\u041E\u041B\u041B\u0410\u0420":return"USD";case"\u20AC":case"\u0404\u0412\u0420\u041E":case"\u0415\u0412\u0420\u041E":return"EUR";default:return t}}convertToDefault(e,r){let t=this.currencyMap().get(this.normalizeCode(r)),n=this.defaultCurrencyDetails();return!t||!n||t.rateToBase<=0||n.rateToBase<=0?e:e*(t.rateToBase/n.rateToBase)}getDefaultCurrencyCode(){return this.defaultCurrencyDetails()?.code??"UAH"}resetToDefaults(){this.currenciesSignal.set([]),this.defaultCurrencySignal.set("")}format(e,r,t=2){let n=r?this.normalizeCode(r):this.getDefaultCurrencyCode();return new Intl.NumberFormat("ru-RU",{style:"currency",currency:n,minimumFractionDigits:t,maximumFractionDigits:t}).format(e)}getSnapshot(){return{currencies:this.currenciesSignal().map(e=>s({},e)),defaultCurrencyId:this.defaultCurrencySignal()}}restoreSnapshot(e){let t=Array.isArray(e.currencies)?e.currencies.map(i=>this.sanitizeCurrency(i)).filter(i=>i!==null):[];this.currenciesSignal.set(t);let n=typeof e.defaultCurrencyId=="string"?e.defaultCurrencyId:"",a=t.some(i=>i.id===n)?n:this.resolveFallbackDefault(t);this.defaultCurrencySignal.set(a)}ensureDefaultCurrency(e){if(!e.length){this.defaultCurrencySignal.set("");return}let r=this.defaultCurrencySignal();e.some(n=>n.id===r)||this.defaultCurrencySignal.set(e[0].id)}loadCurrencies(){let e=this.safeWindow();if(!e)return[];try{let r=e.localStorage.getItem(this.storageKey);if(!r)return[];let t=JSON.parse(r);return Array.isArray(t)?t.map(a=>this.sanitizeCurrency(a)).filter(a=>a!==null):[]}catch{return[]}}loadDefaultCurrency(e){let r=this.safeWindow();if(!r)return this.resolveFallbackDefault(e);try{let t=r.localStorage.getItem(this.defaultStorageKey);if(typeof t=="string"&&t)return t}catch{}return this.resolveFallbackDefault(e)}sanitizeCurrency(e){if(!e||typeof e!="object")return null;let r=e,t=typeof r.id=="string"&&r.id.trim()?r.id.trim():null,n=typeof r.name=="string"&&r.name.trim()?r.name.trim():null,a=typeof r.code=="string"&&r.code.trim()?r.code.trim().toUpperCase():null,i=this.normalizeRate(r.rateToBase);return!t||!n||!a||i===null?null:{id:t,name:n,code:a,rateToBase:i}}normalizeRate(e){if(typeof e=="number")return Number.isFinite(e)&&e>0?e:null;if(typeof e=="string"){let r=Number.parseFloat(e);return Number.isFinite(r)&&r>0?r:null}return null}persistCurrencies(e){let r=this.safeWindow();if(r)try{r.localStorage.setItem(this.storageKey,JSON.stringify(e))}catch{}}persistDefaultCurrency(e){let r=this.safeWindow();if(r)try{if(!e){r.localStorage.removeItem(this.defaultStorageKey);return}r.localStorage.setItem(this.defaultStorageKey,e)}catch{}}resolveFallbackDefault(e){return e.length?e[0].id:""}generateId(e){let r=e.toLowerCase(),t=`currency-${r}`;if(!this.currenciesSignal().some(i=>i.id===t))return t;let a=Math.random().toString(36).slice(2,8);return t=`currency-${r}-${a}`,t}safeWindow(){return typeof window>"u"?null:window}static \u0275fac=function(r){return new(r||u)};static \u0275prov=f({token:u,factory:u.\u0275fac,providedIn:"root"})};export{y as a};
