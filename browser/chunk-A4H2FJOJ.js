import{a as p}from"./chunk-MBWK4RVX.js";import{a as h}from"./chunk-XXUWZJOY.js";import{A as l,J as y,Ua as o,a as d,b as m,f as u,w as g}from"./chunk-X6DWFC4Y.js";var f=class c{storage=l(p);currencyService=l(h);transactionsSignal=y([]);transactions=o(()=>this.transactionsSignal());defaultCurrencyCode=o(()=>this.currencyService.getDefaultCurrencyCode());listItems=o(()=>[...this.transactionsSignal()].sort((e,t)=>this.compareByOccurredAt(e.occurredAt,t.occurredAt)).map(e=>({id:e.id??0,description:e.note?.trim()||(e.type==="income"?"\u0414\u043E\u0445\u043E\u0434":e.type==="expense"?"\u0420\u0430\u0441\u0445\u043E\u0434":"\u041F\u0435\u0440\u0435\u0432\u043E\u0434"),category:e.category,account:e.account,amount:this.applySign(e),currency:this.currencyService.normalizeCode(e.currency),occurredAt:e.occurredAt,type:e.type,convertedAmount:this.toDefaultSigned(e)})));totalIncome=o(()=>this.transactionsSignal().filter(e=>e.type==="income").reduce((e,t)=>e+this.convertToDefault(t),0));totalExpenses=o(()=>this.transactionsSignal().filter(e=>e.type==="expense").reduce((e,t)=>e+this.convertToDefault(t),0));balance=o(()=>this.totalIncome()-this.totalExpenses());currentMonthTotals=o(()=>this.calculateMonthlyTotals(0));previousMonthTotals=o(()=>this.calculateMonthlyTotals(1));currentMonthExpensesByCategory=o(()=>{let e=new Map,t=this.getTransactionsForMonth(0).filter(n=>n.type==="expense");for(let n of t){let r=e.get(n.category)??0;e.set(n.category,r+this.convertToDefault(n))}return[...e.entries()].map(([n,r])=>({category:n,amount:r})).sort((n,r)=>r.amount-n.amount)});constructor(){this.refresh()}refresh(){return u(this,null,function*(){let e=yield this.storage.getTransactions();this.transactionsSignal.set(e)})}addTransaction(e){return u(this,null,function*(){let t=yield this.storage.addTransaction(e);this.transactionsSignal.update(n=>[m(d({},e),{id:t}),...n])})}trend(e,t){return t===0&&e===0?"stable":t===0?e>0?"up":"stable":e===t?"stable":e>t?"up":"down"}describeChange(e,t,n,r=!1){if(e===0&&t===0)return`\u041D\u0435\u0442 \u0434\u0430\u043D\u043D\u044B\u0445 \u043E ${n} \u0437\u0430 \u043F\u043E\u0441\u043B\u0435\u0434\u043D\u0438\u0435 \u0434\u0432\u0430 \u043C\u0435\u0441\u044F\u0446\u0430`;if(t===0)return"\u0412 \u043F\u0440\u043E\u0448\u043B\u043E\u043C \u043C\u0435\u0441\u044F\u0446\u0435 \u0434\u0430\u043D\u043D\u044B\u0445 \u043D\u0435 \u0431\u044B\u043B\u043E";let a=(e-t)/t*100,s=r?-a:a;if(s===0)return"\u0411\u0435\u0437 \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u0438\u0439 \u043F\u043E \u0441\u0440\u0430\u0432\u043D\u0435\u043D\u0438\u044E \u0441 \u043F\u0440\u043E\u0448\u043B\u044B\u043C \u043C\u0435\u0441\u044F\u0446\u0435\u043C";let i=s>0?"\u0431\u043E\u043B\u044C\u0448\u0435":"\u043C\u0435\u043D\u044C\u0448\u0435";return`\u041D\u0430 ${Math.abs(s).toFixed(1).replace(".0","")}% ${i}, \u0447\u0435\u043C \u0432 \u043F\u0440\u043E\u0448\u043B\u043E\u043C \u043C\u0435\u0441\u044F\u0446\u0435`}calculateMonthlyTotals(e){let t=this.getTransactionsForMonth(e),n=t.filter(a=>a.type==="income").reduce((a,s)=>a+this.convertToDefault(s),0),r=t.filter(a=>a.type==="expense").reduce((a,s)=>a+this.convertToDefault(s),0);return{income:n,expenses:r,net:n-r}}getTransactionsForMonth(e){let t=new Date,n=new Date(t.getFullYear(),t.getMonth()-e,1),r=new Date(n.getFullYear(),n.getMonth(),1),a=new Date(n.getFullYear(),n.getMonth()+1,0,23,59,59,999);return this.transactionsSignal().filter(s=>{let i=this.parseDate(s.occurredAt);return i?i>=r&&i<=a:!1})}applySign(e){let t=Math.abs(e.amount);switch(e.type){case"expense":return-t;case"income":return t;default:return 0}}convertToDefault(e){return this.currencyService.convertToDefault(Math.abs(e.amount),this.currencyService.normalizeCode(e.currency))}toDefaultSigned(e){let t=this.convertToDefault(e);switch(e.type){case"expense":return-t;case"income":return t;default:return 0}}compareByOccurredAt(e,t){let n=this.parseDate(e),r=this.parseDate(t);return n&&r?r.getTime()-n.getTime():n&&!r?-1:!n&&r?1:0}parseDate(e){if(!e)return null;let t=new Date(e);return Number.isNaN(t.getTime())?null:t}static \u0275fac=function(t){return new(t||c)};static \u0275prov=g({token:c,factory:c.\u0275fac,providedIn:"root"})};export{f as a};
