import{a as pt,b as St,c as it,d as xt}from"./chunk-RZG4FUBD.js";import{a as Ht}from"./chunk-VLCZRBLA.js";import{a as G}from"./chunk-KX7B4REP.js";import{a as q}from"./chunk-6HSA32IX.js";import{$b as V,A as E,Ab as kt,Ba as gt,Bb as Bt,C,Cb as Dt,D as S,Da as u,Db as Pt,Ea as g,Eb as Mt,Fa as B,Ga as ft,Ia as tt,J as X,Ja as et,Ka as nt,La as ht,Mb as At,Qa as I,R as s,Sa as O,Sb as Ft,Ta as x,Xb as It,Y as k,Ya as vt,Yb as Ot,Z,Za as M,_a as A,_b as $,a as st,aa as _,ac as Tt,b as lt,bb as K,bc as Lt,dc as Nt,ea as yt,f as m,gc as Kt,hc as Rt,ic as $t,ja as d,jc as Vt,ka as a,kc as Gt,la as o,lb as bt,ma as N,na as h,nb as Et,nc as zt,oa as v,ob as Ct,oc as jt,pb as dt,pc as Ut,qa as P,ra as w,sa as p,tb as R,vc as D,w as Q,x as Y,yb as rt,z as J,za as b,zb as wt}from"./chunk-X6DWFC4Y.js";var ot=class i{googleAuth=E(xt);static \u0275fac=function(t){return new(t||i)};static \u0275cmp=k({type:i,selectors:[["app-sync"]],standalone:!1,decls:21,vars:0,consts:[[1,"feature-shell"],[1,"feature-shell__header"],[1,"tag-chip"],[1,"feature-shell__title"],[1,"feature-shell__subtitle"],[1,"feature-shell__actions"],["type","button",3,"click"],["aria-label","\u041D\u0430\u0432\u0438\u0433\u0430\u0446\u0438\u044F \u043F\u043E \u0440\u0430\u0437\u0434\u0435\u043B\u0443",1,"feature-shell__nav"],["mat-button","","routerLink","list","routerLinkActive","feature-shell__nav-link--active"],["mat-button","","routerLink","create","routerLinkActive","feature-shell__nav-link--active"],["mat-button","","routerLink","accounts","routerLinkActive","feature-shell__nav-link--active"],["mat-button","","routerLink","last-restore","routerLinkActive","feature-shell__nav-link--active"]],template:function(t,n){t&1&&(a(0,"section",0)(1,"header",1)(2,"span",2),u(3,"\u0421\u0438\u043D\u0445\u0440\u043E\u043D\u0438\u0437\u0430\u0446\u0438\u044F"),o(),a(4,"h1",3),u(5,"\u0420\u0435\u0437\u0435\u0440\u0432\u043D\u043E\u0435 \u043A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u0435 \u0438 \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u0435"),o(),a(6,"p",4),u(7," \u0414\u0435\u043B\u0430\u0439\u0442\u0435 \u0440\u0435\u0433\u0443\u043B\u044F\u0440\u043D\u044B\u0435 \u0440\u0435\u0437\u0435\u0440\u0432\u043D\u044B\u0435 \u043A\u043E\u043F\u0438\u0438 FinPocket \u0438 \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u0430\u0432\u043B\u0438\u0432\u0430\u0439\u0442\u0435 \u0434\u0430\u043D\u043D\u044B\u0435 \u0441 \u043B\u044E\u0431\u043E\u0433\u043E \u0443\u0441\u0442\u0440\u043E\u0439\u0441\u0442\u0432\u0430. "),o(),a(8,"div",5)(9,"button",6),w("click",function(){return n.googleAuth.startAuthFlow()}),u(10,"\u041F\u043E\u0434\u043A\u043B\u044E\u0447\u0438\u0442\u044C Google Drive"),o()()(),a(11,"nav",7)(12,"a",8),u(13,"\u0418\u0441\u0442\u043E\u0440\u0438\u044F"),o(),a(14,"a",9),u(15,"\u041D\u0430\u0441\u0442\u0440\u043E\u0439\u043A\u0430"),o(),a(16,"a",10),u(17,"\u0410\u043A\u043A\u0430\u0443\u043D\u0442\u044B"),o(),a(18,"a",11),u(19,"\u0414\u0435\u0442\u0430\u043B\u0438"),o()(),N(20,"router-outlet"),o())},dependencies:[bt,Et,Ct,R],styles:["[_nghost-%COMP%]{display:block}.feature-shell__nav[_ngcontent-%COMP%]{display:flex;gap:.5rem;flex-wrap:wrap;margin:1.5rem 0}.feature-shell__nav-link--active[_ngcontent-%COMP%]{background-color:#3f51b51f}.feature-shell__actions[_ngcontent-%COMP%]{margin-top:1.5rem}"]})};function z(i,e=1){if(i==null||Number.isNaN(i))return"\u2014";let t=Number(i);if(t===0)return"0 \u0411";let n=["\u0411","\u041A\u0411","\u041C\u0411","\u0413\u0411","\u0422\u0411"],r=Math.min(Math.floor(Math.log(t)/Math.log(1024)),n.length-1);return`${(t/Math.pow(1024,r)).toFixed(e)} ${n[r]}`}function Yt(i,e){if(i&1&&(a(0,"tr")(1,"td"),u(2),I(3,"date"),o(),a(4,"td"),u(5),o(),a(6,"td",6),u(7),o()()),i&2){let t=e.$implicit;s(2),g(O(3,3,t.createdAt,"d MMMM yyyy, HH:mm")),s(3),g(t.sizeLabel),s(2),g(t.checksum)}}function Xt(i,e){if(i&1&&(h(0),a(1,"table")(2,"thead")(3,"tr")(4,"th"),u(5,"\u0414\u0430\u0442\u0430"),o(),a(6,"th"),u(7,"\u0420\u0430\u0437\u043C\u0435\u0440"),o(),a(8,"th"),u(9,"\u041A\u043E\u043D\u0442\u0440\u043E\u043B\u044C\u043D\u0430\u044F \u0441\u0443\u043C\u043C\u0430"),o()()(),a(10,"tbody"),_(11,Yt,8,6,"tr",5),o()(),v()),i&2){let t=p(3);s(11),d("ngForOf",t.backups)("ngForTrackBy",t.trackByBackup)}}function Zt(i,e){if(i&1&&(h(0),_(1,Xt,12,2,"ng-container",4),v()),i&2){let t=p(2),n=b(13);s(),d("ngIf",t.backups.length)("ngIfElse",n)}}function te(i,e){if(i&1&&(h(0),_(1,Zt,2,2,"ng-container",4),v()),i&2){let t=p(),n=b(15);s(),d("ngIf",!t.error)("ngIfElse",n)}}function ee(i,e){i&1&&(a(0,"p",7),u(1,"\u0417\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u043C \u0441\u043F\u0438\u0441\u043E\u043A \u0440\u0435\u0437\u0435\u0440\u0432\u043D\u044B\u0445 \u043A\u043E\u043F\u0438\u0439\u2026"),o())}function ne(i,e){i&1&&(a(0,"p",7),u(1,"\u0420\u0435\u0437\u0435\u0440\u0432\u043D\u044B\u0435 \u043A\u043E\u043F\u0438\u0438 \u0435\u0449\u0451 \u043D\u0435 \u0441\u043E\u0437\u0434\u0430\u0432\u0430\u043B\u0438\u0441\u044C."),o())}function ie(i,e){if(i&1&&(a(0,"p",8),u(1),o()),i&2){let t=p();s(),g(t.error)}}var j=class i{backups=[];isLoading=!0;error;db=E(G);subscription;constructor(){this.subscription=q(()=>this.db.backups.orderBy("createdAt").reverse().toArray()).subscribe({next:e=>{this.backups=e.map(t=>this.mapEntity(t)),this.isLoading=!1,this.error=void 0},error:e=>{console.error("[SyncList] Failed to load backups",e),this.error=e instanceof Error?e.message:"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0440\u0435\u0437\u0435\u0440\u0432\u043D\u044B\u0435 \u043A\u043E\u043F\u0438\u0438",this.isLoading=!1}})}ngOnDestroy(){this.subscription?.unsubscribe()}trackByBackup(e,t){return t.id}mapEntity(e){return{id:e.id,createdAt:e.createdAt,sizeLabel:z(e.size),checksum:e.checksum}}static \u0275fac=function(t){return new(t||i)};static \u0275cmp=k({type:i,selectors:[["app-sync-list"]],decls:16,vars:2,consts:[["loading",""],["empty",""],["errorTpl",""],[1,"sync-list"],[4,"ngIf","ngIfElse"],[4,"ngFor","ngForOf","ngForTrackBy"],[1,"sync-list__checksum"],[1,"sync-list__state"],[1,"sync-list__state","sync-list__state--error"]],template:function(t,n){if(t&1&&(a(0,"section",3)(1,"header")(2,"h2"),u(3,"\u0420\u0435\u0437\u0435\u0440\u0432\u043D\u044B\u0435 \u043A\u043E\u043F\u0438\u0438"),o(),a(4,"p"),u(5,"\u041F\u0435\u0440\u0435\u0447\u0435\u043D\u044C \u043F\u043E\u0441\u043B\u0435\u0434\u043D\u0438\u0445 \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u0438\u0439 \u0432\u0430\u0448\u0438\u0445 \u0434\u0430\u043D\u043D\u044B\u0445 \u0432 \u043E\u0431\u043B\u0430\u043A\u0435."),o()(),a(6,"mat-card")(7,"mat-card-title"),u(8,"\u0418\u0441\u0442\u043E\u0440\u0438\u044F"),o(),_(9,te,2,2,"ng-container",4),o(),_(10,ee,2,0,"ng-template",null,0,x)(12,ne,2,0,"ng-template",null,1,x)(14,ie,2,1,"ng-template",null,2,x),o()),t&2){let r=b(11);s(9),d("ngIf",!n.isLoading)("ngIfElse",r)}},dependencies:[D,M,A,$,V,K],styles:[".sync-list[_ngcontent-%COMP%]{display:grid;gap:1.5rem}.sync-list[_ngcontent-%COMP%]   table[_ngcontent-%COMP%]{width:100%;border-collapse:collapse}.sync-list[_ngcontent-%COMP%]   th[_ngcontent-%COMP%], .sync-list[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{padding:.75rem;border-bottom:1px solid rgba(0,0,0,.08);text-align:left}.sync-list__checksum[_ngcontent-%COMP%]{font-family:Roboto Mono,SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:.8125rem;word-break:break-all}.sync-list__state[_ngcontent-%COMP%]{margin:1rem 0 0;color:#0000008a}.sync-list__state--error[_ngcontent-%COMP%]{color:#c62828}"],changeDetection:0})};var U=class i{constructor(e){this.settings=e}cache=new Map;cachedGDriveClientId;listProviders(){let e=[],t=this.settings.getGoogleDriveClientId();return t&&e.push(this.ensureGDriveProvider(t)),e}getProvider(e){switch(e){case"gdrive":{let t=this.settings.getGoogleDriveClientId();return t?this.ensureGDriveProvider(t):null}default:return null}}invalidate(e){(!e||e==="gdrive")&&(this.cache.delete("gdrive"),this.cachedGDriveClientId=void 0),e||this.cache.clear()}ensureGDriveProvider(e){if(this.cachedGDriveClientId===e){let n=this.cache.get("gdrive");if(n)return n}let t=new St({clientId:e});return this.cachedGDriveClientId=e,this.cache.set("gdrive",t),t}static \u0275fac=function(t){return new(t||i)(J(it))};static \u0275prov=Q({token:i,factory:i.\u0275fac,providedIn:"root"})};function re(i,e){if(i&1&&(a(0,"mat-option",12),u(1),o()),i&2){let t=e.$implicit;d("value",t.id),s(),B(" ",t.title," ")}}function oe(i,e){if(i&1&&(a(0,"article")(1,"h3"),u(2),o(),a(3,"p"),u(4),o()()),i&2){let t=e.$implicit,n=p();gt("sync-edit__option--active",t.id===n.selectedProvider),s(2),g(t.title),s(2),g(t.description)}}function ae(i,e){i&1&&(a(0,"mat-error"),u(1," Client ID Google Drive \u0434\u043E\u043B\u0436\u0435\u043D \u043E\u043A\u0430\u043D\u0447\u0438\u0432\u0430\u0442\u044C\u0441\u044F \u043D\u0430 .apps.googleusercontent.com \u0438 \u043D\u0435 \u0441\u043E\u0434\u0435\u0440\u0436\u0430\u0442\u044C \u043F\u0440\u043E\u0431\u0435\u043B\u043E\u0432. "),o())}function ue(i,e){if(i&1){let t=P();h(0),a(1,"mat-form-field",4)(2,"mat-label"),u(3,"Google OAuth Client ID"),o(),a(4,"input",13,1),nt("ngModelChange",function(r){C(t);let c=p();return et(c.gdriveClientId,r)||(c.gdriveClientId=r),S(r)}),o(),a(6,"mat-hint"),u(7,"Client ID \u0438\u0437 \u043A\u043E\u043D\u0441\u043E\u043B\u0438 Google Cloud. \u0417\u043D\u0430\u0447\u0435\u043D\u0438\u0435 \u0441\u043E\u0445\u0440\u0430\u043D\u044F\u0435\u0442\u0441\u044F \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u043E."),o(),_(8,ae,2,0,"mat-error",9),o(),a(9,"p",14),u(10," \u0411\u0435\u0437 Client ID \u0430\u0432\u0442\u043E\u0440\u0438\u0437\u0430\u0446\u0438\u044F Google Drive \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430. \u041F\u043E\u0441\u043B\u0435 \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u044F \u0437\u043D\u0430\u0447\u0435\u043D\u0438\u044F \u043F\u043E\u0432\u0442\u043E\u0440\u043D\u043E \u043E\u0442\u043A\u0440\u043E\u0439\u0442\u0435 \u0440\u0430\u0437\u0434\u0435\u043B \xAB\u0410\u043A\u043A\u0430\u0443\u043D\u0442\u044B\xBB \u0438 \u0432\u044B\u043F\u043E\u043B\u043D\u0438\u0442\u0435 \u0432\u0445\u043E\u0434. "),o(),v()}if(i&2){let t=b(5),n=p();s(4),tt("ngModel",n.gdriveClientId),d("pattern",n.gdriveClientIdPatternSource),s(4),d("ngIf",(t.errors==null?null:t.errors.pattern)&&(t.dirty||t.touched))}}var T=class i{settings=E(it);registry=E(U);snackBar=E(rt);providers=[{id:"gdrive",title:"Google Drive",description:"\u0418\u0441\u043F\u043E\u043B\u044C\u0437\u0443\u0439\u0442\u0435 \u0441\u043E\u0431\u0441\u0442\u0432\u0435\u043D\u043D\u044B\u0439 OAuth 2.0 Client ID \u0434\u043B\u044F \u0434\u043E\u0441\u0442\u0443\u043F\u0430 \u043A \u0444\u0430\u0439\u043B\u0430\u043C \u043F\u0440\u0438\u043B\u043E\u0436\u0435\u043D\u0438\u044F \u0432 Google Drive.",requiresClientId:!0}];selectedProvider=this.providers[0].id;encryptionEnabled=this.settings.getEncryptionEnabled();gdriveClientId=this.settings.getGoogleDriveClientId()??"";gdriveClientIdPattern=pt;gdriveClientIdPatternSource=pt.source.replace(/^\^|\$$/g,"");save(e){if(e.invalid){e.control.markAllAsTouched(),this.snackBar.open("\u0418\u0441\u043F\u0440\u0430\u0432\u044C\u0442\u0435 \u043E\u0448\u0438\u0431\u043A\u0438 \u0432 \u043D\u0430\u0441\u0442\u0440\u043E\u0439\u043A\u0430\u0445 \u0438 \u043F\u043E\u043F\u0440\u043E\u0431\u0443\u0439\u0442\u0435 \u0435\u0449\u0451 \u0440\u0430\u0437.","OK",{duration:5e3});return}if(this.selectedProvider==="gdrive"){let t=this.gdriveClientId.trim();if(t.length&&!this.gdriveClientIdPattern.test(t)){this.snackBar.open("Client ID Google Drive \u0438\u043C\u0435\u0435\u0442 \u043D\u0435\u0432\u0435\u0440\u043D\u044B\u0439 \u0444\u043E\u0440\u043C\u0430\u0442.","OK",{duration:5e3});return}this.settings.setGoogleDriveClientId(t.length?t:null),this.registry.invalidate("gdrive")}this.settings.setEncryptionEnabled(this.encryptionEnabled),this.snackBar.open("\u041D\u0430\u0441\u0442\u0440\u043E\u0439\u043A\u0438 \u0441\u0438\u043D\u0445\u0440\u043E\u043D\u0438\u0437\u0430\u0446\u0438\u0438 \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u044B.","OK",{duration:4e3})}static \u0275fac=function(t){return new(t||i)};static \u0275cmp=k({type:i,selectors:[["app-sync-edit"]],decls:20,vars:5,consts:[["syncForm","ngForm"],["gdriveClientIdModel","ngModel"],[1,"sync-edit"],[1,"sync-edit__form",3,"ngSubmit"],["appearance","outline"],["name","provider",3,"ngModelChange","ngModel"],[3,"value",4,"ngFor","ngForOf"],[1,"sync-edit__options"],[3,"sync-edit__option--active",4,"ngFor","ngForOf"],[4,"ngIf"],["name","encryption",3,"ngModelChange","ngModel"],["mat-raised-button","","color","primary","type","submit"],[3,"value"],["matInput","","name","gdriveClientId","autocomplete","off","placeholder","1234567890-abc.apps.googleusercontent.com",3,"ngModelChange","ngModel","pattern"],[1,"sync-edit__note"]],template:function(t,n){if(t&1){let r=P();a(0,"section",2)(1,"header")(2,"h2"),u(3,"\u041D\u0430\u0441\u0442\u0440\u043E\u0439\u043A\u0438 \u0441\u0438\u043D\u0445\u0440\u043E\u043D\u0438\u0437\u0430\u0446\u0438\u0438"),o(),a(4,"p"),u(5,"\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u043E\u0431\u043B\u0430\u043A\u043E \u0438 \u043F\u0430\u0440\u0430\u043C\u0435\u0442\u0440\u044B \u0437\u0430\u0449\u0438\u0442\u044B \u0434\u043B\u044F \u0440\u0435\u0437\u0435\u0440\u0432\u043D\u043E\u0433\u043E \u043A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u044F."),o()(),a(6,"form",3,0),w("ngSubmit",function(){C(r);let l=b(7);return S(n.save(l))}),a(8,"mat-form-field",4)(9,"mat-label"),u(10,"\u041E\u0431\u043B\u0430\u0447\u043D\u044B\u0439 \u043F\u0440\u043E\u0432\u0430\u0439\u0434\u0435\u0440"),o(),a(11,"mat-select",5),nt("ngModelChange",function(l){return C(r),et(n.selectedProvider,l)||(n.selectedProvider=l),S(l)}),_(12,re,2,2,"mat-option",6),o()(),a(13,"section",7),_(14,oe,5,4,"article",8),o(),_(15,ue,11,3,"ng-container",9),a(16,"mat-slide-toggle",10),nt("ngModelChange",function(l){return C(r),et(n.encryptionEnabled,l)||(n.encryptionEnabled=l),S(l)}),u(17,"\u0428\u0438\u0444\u0440\u043E\u0432\u0430\u0442\u044C \u0440\u0435\u0437\u0435\u0440\u0432\u043D\u044B\u0435 \u043A\u043E\u043F\u0438\u0438"),o(),a(18,"button",11),u(19,"\u0421\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C"),o()()()}t&2&&(s(11),tt("ngModel",n.selectedProvider),s(),d("ngForOf",n.providers),s(2),d("ngForOf",n.providers),s(),d("ngIf",n.selectedProvider==="gdrive"),s(),tt("ngModel",n.encryptionEnabled))},dependencies:[D,M,A,Mt,wt,kt,Bt,At,Pt,Dt,R,Kt,Gt,Rt,Vt,$t,zt,Ut,jt],styles:[".sync-edit[_ngcontent-%COMP%]{display:grid;gap:1.5rem}.sync-edit__form[_ngcontent-%COMP%]{display:grid;gap:1rem;max-width:520px}.sync-edit__form[_ngcontent-%COMP%]   mat-form-field[_ngcontent-%COMP%]{width:100%}.sync-edit__options[_ngcontent-%COMP%]{display:grid;gap:.75rem}.sync-edit__options[_ngcontent-%COMP%]   article[_ngcontent-%COMP%]{padding:1rem;border-radius:.75rem;border:1px solid rgba(0,0,0,.1)}.sync-edit__option--active[_ngcontent-%COMP%]{border-color:#3f51b580;box-shadow:0 0 0 2px #3f51b51a}.sync-edit__note[_ngcontent-%COMP%]{margin:-.5rem 0 0;font-size:.875rem;color:#0000008a}"],changeDetection:0})};function ce(i,e){if(i&1&&(h(0),a(1,"ul")(2,"li")(3,"strong"),u(4,"\u0421\u043E\u0437\u0434\u0430\u043D\u0430:"),o(),u(5),I(6,"date"),o(),a(7,"li")(8,"strong"),u(9,"\u0420\u0430\u0437\u043C\u0435\u0440:"),o(),u(10),o(),a(11,"li",6)(12,"strong"),u(13,"\u041A\u043E\u043D\u0442\u0440\u043E\u043B\u044C\u043D\u0430\u044F \u0441\u0443\u043C\u043C\u0430:"),o(),u(14),o()(),v()),i&2){let t=p(3);s(5),B(" ",O(6,3,t.latestBackup.createdAt,"d MMMM yyyy, HH:mm")),s(5),B(" ",t.latestBackup.sizeLabel),s(4),B(" ",t.latestBackup.checksum)}}function se(i,e){if(i&1&&(h(0),_(1,ce,15,6,"ng-container",4),v()),i&2){let t=p(2),n=b(18);s(),d("ngIf",t.latestBackup)("ngIfElse",n)}}function le(i,e){if(i&1&&(h(0),_(1,se,2,2,"ng-container",4),v()),i&2){let t=p(),n=b(20);s(),d("ngIf",!t.error)("ngIfElse",n)}}function de(i,e){if(i&1&&(a(0,"li")(1,"span"),u(2),o(),a(3,"strong"),u(4),o()()),i&2){let t=e.$implicit;s(2),g(t.label),s(2),g(t.result)}}function pe(i,e){i&1&&(a(0,"p",7),u(1,"\u0417\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u043C \u0438\u043D\u0444\u043E\u0440\u043C\u0430\u0446\u0438\u044E \u043E \u0440\u0435\u0437\u0435\u0440\u0432\u043D\u044B\u0445 \u043A\u043E\u043F\u0438\u044F\u0445\u2026"),o())}function me(i,e){i&1&&(a(0,"p",7),u(1,"\u0420\u0435\u0437\u0435\u0440\u0432\u043D\u044B\u0435 \u043A\u043E\u043F\u0438\u0438 \u0435\u0449\u0451 \u043D\u0435 \u0441\u043E\u0437\u0434\u0430\u0432\u0430\u043B\u0438\u0441\u044C."),o())}function _e(i,e){if(i&1&&(a(0,"p",8),u(1),o()),i&2){let t=p();s(),g(t.error)}}var L=class i{latestBackup;integrityChecks=[];isLoading=!0;error;db=E(G);backupSubscription;integritySubscription;constructor(){this.backupSubscription=q(()=>this.db.backups.orderBy("createdAt").reverse().limit(1).toArray()).subscribe({next:e=>{let[t]=e;this.latestBackup=t?{id:t.id,createdAt:t.createdAt,sizeLabel:z(t.size),checksum:t.checksum}:void 0,this.isLoading=!1,this.error=void 0},error:e=>{console.error("[SyncDetails] Failed to load latest backup",e),this.error=e instanceof Error?e.message:"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0434\u0430\u043D\u043D\u044B\u0435",this.isLoading=!1}}),this.integritySubscription=q(()=>m(this,null,function*(){return{transactions:yield this.db.transactions.count(),accounts:yield this.db.accounts.count(),debts:yield this.db.debts.count(),meters:yield this.db.meters.count(),categories:yield this.db.categories.count(),backups:yield this.db.backups.count()}})).subscribe({next:e=>{this.integrityChecks=[{label:"\u0422\u0440\u0430\u043D\u0437\u0430\u043A\u0446\u0438\u0438",result:`${e.transactions} \u0437\u0430\u043F\u0438\u0441\u0435\u0439`},{label:"\u0421\u0447\u0435\u0442\u0430",result:`${e.accounts} \u0437\u0430\u043F\u0438\u0441\u0435\u0439`},{label:"\u0414\u043E\u043B\u0433\u0438",result:`${e.debts} \u0437\u0430\u043F\u0438\u0441\u0435\u0439`},{label:"\u041F\u043E\u043A\u0430\u0437\u0430\u043D\u0438\u044F \u0441\u0447\u0451\u0442\u0447\u0438\u043A\u043E\u0432",result:`${e.meters} \u0437\u0430\u043F\u0438\u0441\u0435\u0439`},{label:"\u041A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u0438",result:`${e.categories} \u0437\u0430\u043F\u0438\u0441\u0435\u0439`},{label:"\u0420\u0435\u0437\u0435\u0440\u0432\u043D\u044B\u0435 \u043A\u043E\u043F\u0438\u0438",result:`${e.backups} \u0444\u0430\u0439\u043B\u043E\u0432`}]},error:e=>{console.error("[SyncDetails] Failed to compute integrity checks",e)}})}ngOnDestroy(){this.backupSubscription?.unsubscribe(),this.integritySubscription?.unsubscribe()}static \u0275fac=function(t){return new(t||i)};static \u0275cmp=k({type:i,selectors:[["app-sync-details"]],decls:21,vars:3,consts:[["loading",""],["empty",""],["errorTpl",""],[1,"sync-details"],[4,"ngIf","ngIfElse"],[4,"ngFor","ngForOf"],[1,"sync-details__checksum"],[1,"sync-details__state"],[1,"sync-details__state","sync-details__state--error"]],template:function(t,n){if(t&1&&(a(0,"section",3)(1,"header")(2,"h2"),u(3,"\u041F\u043E\u0434\u0440\u043E\u0431\u043D\u043E\u0441\u0442\u0438 \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u044F"),o(),a(4,"p"),u(5,"\u041F\u043E\u0441\u043B\u0435\u0434\u043D\u0438\u0435 \u043E\u043F\u0435\u0440\u0430\u0446\u0438\u0438 \u0441\u0438\u043D\u0445\u0440\u043E\u043D\u0438\u0437\u0430\u0446\u0438\u0438 \u0434\u043B\u044F \u043A\u043E\u043D\u0442\u0440\u043E\u043B\u044F \u043A\u0430\u0447\u0435\u0441\u0442\u0432\u0430 \u0440\u0435\u0437\u0435\u0440\u0432\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u044F."),o()(),a(6,"mat-card")(7,"mat-card-title"),u(8,"\u041F\u043E\u0441\u043B\u0435\u0434\u043D\u044F\u044F \u0440\u0435\u0437\u0435\u0440\u0432\u043D\u0430\u044F \u043A\u043E\u043F\u0438\u044F"),o(),_(9,le,2,2,"ng-container",4),o(),a(10,"mat-card")(11,"mat-card-title"),u(12,"\u041F\u0440\u043E\u0432\u0435\u0440\u043A\u0438 \u0446\u0435\u043B\u043E\u0441\u0442\u043D\u043E\u0441\u0442\u0438"),o(),a(13,"ul"),_(14,de,5,2,"li",5),o()()(),_(15,pe,2,0,"ng-template",null,0,x)(17,me,2,0,"ng-template",null,1,x)(19,_e,2,1,"ng-template",null,2,x)),t&2){let r=b(16);s(9),d("ngIf",!n.isLoading)("ngIfElse",r),s(5),d("ngForOf",n.integrityChecks)}},dependencies:[D,M,A,$,V,K],styles:[".sync-details[_ngcontent-%COMP%]{display:grid;gap:1.5rem}.sync-details[_ngcontent-%COMP%]   ul[_ngcontent-%COMP%]{list-style:none;margin:0;padding:0;display:grid;gap:.75rem}.sync-details[_ngcontent-%COMP%]   li[_ngcontent-%COMP%]{display:flex;justify-content:space-between;gap:1rem}.sync-details__checksum[_ngcontent-%COMP%]{word-break:break-all}.sync-details__state[_ngcontent-%COMP%]{margin:1rem 0 0;color:#0000008a}.sync-details__state--error[_ngcontent-%COMP%]{color:#c62828}"],changeDetection:0})};var ye=1e5,ge=25e4,ut=class i{constructor(e,t){this.db=e;this.syncQueue=t}exportBackup(e){return m(this,null,function*(){let t={version:"1.0",timestamp:new Date().toISOString(),data:{transactions:yield this.db.transactions.toArray(),accounts:yield this.db.accounts.toArray(),debts:yield this.db.debts.toArray(),debtTransactions:yield this.db.debtTransactions.toArray(),meters:yield this.db.meters.toArray(),categories:yield this.db.categories.toArray()}},n=JSON.stringify(t),r=yield this.encryptData(n,e),c=new Blob([JSON.stringify(r)],{type:"application/json"});return yield this.db.backups.add({createdAt:new Date().toISOString(),size:c.size,checksum:yield this.computeChecksum(n),payload:r}),c})}importBackup(e,t){return m(this,null,function*(){let n=yield e.text(),r=JSON.parse(n),c=yield this.decryptData(r,t),l=JSON.parse(c);yield this.db.transaction("rw",this.db.tables,()=>m(this,null,function*(){yield this.db.transactions.clear(),yield this.db.accounts.clear(),yield this.db.debts.clear(),yield this.db.debtTransactions.clear(),yield this.db.meters.clear(),yield this.db.categories.clear(),yield this.db.transactions.bulkAdd(l.data.transactions),yield this.db.accounts.bulkAdd(l.data.accounts),yield this.db.debts.bulkAdd(l.data.debts),yield this.db.debtTransactions.bulkAdd(l.data.debtTransactions),yield this.db.meters.bulkAdd(l.data.meters),yield this.db.categories.bulkAdd(l.data.categories)}))})}twoWaySync(e,t,n){return m(this,null,function*(){if(!(yield e.isAuthenticated()))throw new Error("Provider not authenticated");if(yield e.ensureAppFolder(),n==="upload"||n==="two-way"){let c=yield this.exportBackup(t),l=`backup-${new Date().toISOString()}.json`;yield e.uploadBackup(l,c)}if(n==="download"||n==="two-way"){let c=yield e.listBackups();if(c.length>0){let l=c.sort((f,W)=>W.modified-f.modified)[0],y=yield e.downloadBackup(l.id);yield this.importBackup(y,t)}}})}queueChange(e,t,n,r){return m(this,null,function*(){yield this.syncQueue.append({entityType:e,entityId:t,action:n,payload:r})})}encryptData(e,t){return m(this,null,function*(){let n=crypto.getRandomValues(new Uint8Array(16)),r=crypto.getRandomValues(new Uint8Array(12)),c=yield this.deriveKey(t,n),y=new TextEncoder().encode(e),f=yield crypto.subtle.encrypt({name:"AES-GCM",iv:r},c,y);return{version:"1.0",iv:this.arrayBufferToBase64(r),salt:this.arrayBufferToBase64(n),data:this.arrayBufferToBase64(f)}})}decryptData(e,t){return m(this,null,function*(){let n=this.base64ToArrayBuffer(e.salt),r=this.base64ToArrayBuffer(e.iv),c=this.base64ToArrayBuffer(e.data),l=yield this.deriveKey(t,new Uint8Array(n)),y=yield crypto.subtle.decrypt({name:"AES-GCM",iv:new Uint8Array(r)},l,c);return new TextDecoder().decode(y)})}deriveKey(e,t){return m(this,null,function*(){let n=new TextEncoder,r=yield crypto.subtle.importKey("raw",n.encode(e),"PBKDF2",!1,["deriveBits","deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:t.buffer,iterations:ye,hash:"SHA-256"},r,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"])})}deriveKeyFromPassphrase(e,t){return m(this,null,function*(){let n=new TextEncoder,r=yield crypto.subtle.importKey("raw",n.encode(e),"PBKDF2",!1,["deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:t,iterations:ge,hash:"SHA-256"},r,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])})}encryptJson(e,t){return m(this,null,function*(){let n=crypto.getRandomValues(new Uint8Array(12)),c=new TextEncoder().encode(JSON.stringify(e)),l=yield crypto.subtle.encrypt({name:"AES-GCM",iv:n},t,c),y={ver:1,iv:this.arrayBufferToBase64(n),data:this.arrayBufferToBase64(l)};return new Blob([JSON.stringify(y)],{type:"application/json"})})}decryptJson(e,t){return m(this,null,function*(){let n=yield e.text(),r=JSON.parse(n);if(r?.ver!==1||!r.iv||!r.data)throw new Error("\u041D\u0435\u043F\u043E\u0434\u0434\u0435\u0440\u0436\u0438\u0432\u0430\u0435\u043C\u044B\u0439 \u0444\u043E\u0440\u043C\u0430\u0442 \u0440\u0435\u0437\u0435\u0440\u0432\u043D\u043E\u0439 \u043A\u043E\u043F\u0438\u0438");let c=new Uint8Array(this.base64ToArrayBuffer(r.iv)),l=this.base64ToArrayBuffer(r.data),y=yield crypto.subtle.decrypt({name:"AES-GCM",iv:c},t,l),W=new TextDecoder().decode(y);return JSON.parse(W)})}storeEncryptionKey(e,t,n){return m(this,null,function*(){let r=yield crypto.subtle.exportKey("raw",t),c=crypto.getRandomValues(new Uint8Array(16)),l=crypto.getRandomValues(new Uint8Array(12)),y=yield this.deriveKey(n,c),f=yield crypto.subtle.encrypt({name:"AES-GCM",iv:l},y,r),W={keyName:e,encryptedKey:this.arrayBufferToBase64(f),salt:this.arrayBufferToBase64(c),iv:this.arrayBufferToBase64(l),createdAt:new Date().toISOString()},_t=yield this.db.encryptionKeys.where("keyName").equals(e).first();_t?.id&&(yield this.db.encryptionKeys.delete(_t.id)),yield this.db.encryptionKeys.add(W)})}retrieveEncryptionKey(e,t){return m(this,null,function*(){let n=yield this.db.encryptionKeys.where("keyName").equals(e).first();if(!n)return null;let r=this.base64ToArrayBuffer(n.salt),c=this.base64ToArrayBuffer(n.iv),l=this.base64ToArrayBuffer(n.encryptedKey),y=yield this.deriveKey(t,new Uint8Array(r)),f=yield crypto.subtle.decrypt({name:"AES-GCM",iv:new Uint8Array(c)},y,l);return crypto.subtle.importKey("raw",f,"AES-GCM",!0,["encrypt","decrypt"])})}computeChecksum(e){return m(this,null,function*(){let t=new TextEncoder,n=yield crypto.subtle.digest("SHA-256",t.encode(e));return this.arrayBufferToBase64(n)})}arrayBufferToBase64(e){let t=new Uint8Array(e),n="";for(let r=0;r<t.length;r++)n+=String.fromCharCode(t[r]);return btoa(n)}base64ToArrayBuffer(e){let t=atob(e),n=new Uint8Array(t.length);for(let r=0;r<t.length;r++)n[r]=t.charCodeAt(r);return n.buffer}static \u0275fac=function(t){return new(t||i)(J(G),J(Ht))};static \u0275prov=Q({token:i,factory:i.\u0275fac,providedIn:"root"})};function fe(i,e){i&1&&(h(0),a(1,"mat-card",5)(2,"p",6),u(3,"\u0417\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u043C \u0441\u0432\u0435\u0434\u0435\u043D\u0438\u044F \u043E \u043F\u043E\u0434\u043A\u043B\u044E\u0447\u0451\u043D\u043D\u044B\u0445 \u0441\u0435\u0440\u0432\u0438\u0441\u0430\u0445\u2026"),o()(),v())}function he(i,e){if(i&1&&(a(0,"span",20),u(1),I(2,"date"),o()),i&2){let t=p().$implicit;s(),B(" \u041F\u043E\u0441\u043B\u0435\u0434\u043D\u044F\u044F \u0441\u0438\u043D\u0445\u0440\u043E\u043D\u0438\u0437\u0430\u0446\u0438\u044F: ",O(2,1,t.lastSync,"medium")," ")}}function ve(i,e){if(i&1&&(h(0),u(1),v()),i&2){let t=p().$implicit;s(),B(" \xB7 ",(t.user==null?null:t.user.email)||(t.user==null?null:t.user.name)," ")}}function be(i,e){if(i&1){let t=P();a(0,"button",21),w("click",function(){C(t);let r=p().$implicit,c=p(4);return S(c.connect(r))}),u(1," \u0412\u043E\u0439\u0442\u0438 "),o()}}function Ee(i,e){if(i&1){let t=P();a(0,"button",22),w("click",function(){C(t);let r=p().$implicit,c=p(4);return S(c.disconnect(r))}),u(1," \u0412\u044B\u0439\u0442\u0438 "),o()}}function Ce(i,e){if(i&1){let t=P();a(0,"mat-list-item")(1,"div",26)(2,"div",27)(3,"span",28),u(4),o(),a(5,"span",29),u(6),I(7,"date"),o()(),a(8,"div",30)(9,"button",31),w("click",function(){let r=C(t).$implicit,c=p(2).$implicit,l=p(4);return S(l.restoreBackup(c,r))}),u(10," \u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C "),o(),a(11,"button",32),w("click",function(){let r=C(t).$implicit,c=p(2).$implicit,l=p(4);return S(l.deleteBackup(c,r))}),u(12," \u0423\u0434\u0430\u043B\u0438\u0442\u044C "),o()()()()}if(i&2){let t=e.$implicit,n=p(2).$implicit;s(4),g(t.name),s(2),ft(" ",O(7,5,t.modified,"medium")," \xB7 ",t.sizeLabel," "),s(3),d("disabled",!n.connected),s(2),d("disabled",!n.connected)}}function Se(i,e){if(i&1&&(a(0,"section",23)(1,"header",24)(2,"h3"),u(3,"\u0420\u0435\u0437\u0435\u0440\u0432\u043D\u044B\u0435 \u043A\u043E\u043F\u0438\u0438"),o()(),N(4,"mat-divider"),a(5,"mat-list"),_(6,Ce,13,8,"mat-list-item",25),o()()),i&2){let t=p().$implicit,n=p(4);s(6),d("ngForOf",t.backups)("ngForTrackBy",n.trackByBackup)}}function xe(i,e){if(i&1&&(a(0,"li"),u(1),o()),i&2){let t=e.$implicit;s(),g(t)}}function we(i,e){if(i&1&&(a(0,"section",33)(1,"header",24)(2,"h3"),u(3,"\u041F\u043E\u0441\u043B\u0435\u0434\u043D\u0438\u0435 \u0441\u043E\u0431\u044B\u0442\u0438\u044F"),o()(),N(4,"mat-divider"),a(5,"ul"),_(6,xe,2,1,"li",34),o()()),i&2){let t=p().$implicit;s(6),d("ngForOf",t.recentErrors)}}function ke(i,e){if(i&1){let t=P();a(0,"mat-card",5)(1,"mat-card-header")(2,"div",8),N(3,"span",9),a(4,"span",10),u(5),o(),_(6,he,3,4,"span",11),o(),a(7,"mat-card-title",12),u(8),o(),a(9,"mat-card-subtitle"),u(10),_(11,ve,2,1,"ng-container",13),o()(),a(12,"mat-card-content")(13,"div",14),_(14,be,2,0,"button",15)(15,Ee,2,0,"button",16),a(16,"button",17),w("click",function(){let r=C(t).$implicit,c=p(4);return S(c.triggerUpload(r))}),u(17," \u0412\u044B\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0434\u0430\u043D\u043D\u044B\u0435 "),o(),a(18,"button",17),w("click",function(){let r=C(t).$implicit,c=p(4);return S(c.triggerDownload(r))}),u(19," \u0417\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u043F\u043E\u0441\u043B\u0435\u0434\u043D\u0438\u0439 "),o()(),_(20,Se,7,2,"section",18)(21,we,7,1,"section",19),o()()}if(i&2){let t=e.$implicit,n=p(4);yt("aria-labelledby","provider-"+t.id+"-title"),s(3),d("ngClass",n.statusClass(t.status)),s(2),g(n.statusLabel(t.status)),s(),d("ngIf",t.lastSync),s(),d("id",ht("provider-",t.id,"-title")),s(),g(t.title),s(2),B(" ",t.description," "),s(),d("ngIf",t.user),s(3),d("ngIf",!t.connected),s(),d("ngIf",t.connected),s(),d("disabled",!t.connected),s(2),d("disabled",!t.connected||!t.backups.length),s(2),d("ngIf",t.backups.length),s(),d("ngIf",t.recentErrors.length)}}function Be(i,e){if(i&1&&(h(0),_(1,ke,22,15,"mat-card",7),v()),i&2){let t=p(3);s(),d("ngForOf",t.providers())("ngForTrackBy",t.trackByProvider)}}function De(i,e){if(i&1&&(h(0),_(1,Be,2,2,"ng-container",4),v()),i&2){let t=p(2),n=b(5);s(),d("ngIf",t.providers().length)("ngIfElse",n)}}function Pe(i,e){if(i&1&&(a(0,"section",3),_(1,De,2,2,"ng-container",4),o()),i&2){let t=p(),n=b(7);s(),d("ngIf",!t.loadError())("ngIfElse",n)}}function Me(i,e){i&1&&(a(0,"mat-card",5)(1,"p",6),u(2," \u041F\u0440\u043E\u0432\u0430\u0439\u0434\u0435\u0440\u044B \u0441\u0438\u043D\u0445\u0440\u043E\u043D\u0438\u0437\u0430\u0446\u0438\u0438 \u0435\u0449\u0451 \u043D\u0435 \u043D\u0430\u0441\u0442\u0440\u043E\u0435\u043D\u044B. \u0423\u043A\u0430\u0436\u0438\u0442\u0435 \u043F\u0430\u0440\u0430\u043C\u0435\u0442\u0440\u044B \u043F\u043E\u0434\u043A\u043B\u044E\u0447\u0435\u043D\u0438\u044F \u0432 \u0440\u0430\u0437\u0434\u0435\u043B\u0435 \xAB\u041D\u0430\u0441\u0442\u0440\u043E\u0439\u043A\u0430\xBB. "),o()())}function Ae(i,e){if(i&1&&(a(0,"mat-card",5)(1,"p",35),u(2),o()()),i&2){let t=p();s(2),g(t.loadError())}}var qt=5,H=class i{statusLabels={offline:"\u041D\u0435 \u043F\u043E\u0434\u043A\u043B\u044E\u0447\u0435\u043D",connected:"\u041F\u043E\u0434\u043A\u043B\u044E\u0447\u0435\u043D",syncing:"\u0421\u0438\u043D\u0445\u0440\u043E\u043D\u0438\u0437\u0430\u0446\u0438\u044F",error:"\u0415\u0441\u0442\u044C \u043E\u0448\u0438\u0431\u043A\u0438"};descriptions={gdrive:"\u041E\u0431\u043B\u0430\u0447\u043D\u043E\u0435 \u0445\u0440\u0430\u043D\u0438\u043B\u0438\u0449\u0435 Google \u0441 \u043D\u0430\u0434\u0451\u0436\u043D\u043E\u0439 \u0430\u0432\u0442\u043E\u0440\u0438\u0437\u0430\u0446\u0438\u0435\u0439 \u0447\u0435\u0440\u0435\u0437 OAuth 2.0.",onedrive:"OneDrive \u043F\u043E\u043A\u0430 \u043D\u0435 \u043F\u043E\u0434\u0434\u0435\u0440\u0436\u0438\u0432\u0430\u0435\u0442\u0441\u044F.",dropbox:"Dropbox \u043F\u043E\u043A\u0430 \u043D\u0435 \u043F\u043E\u0434\u0434\u0435\u0440\u0436\u0438\u0432\u0430\u0435\u0442\u0441\u044F."};providers=X([]);isLoading=X(!1);loadError=X(null);registry=E(U);syncService=E(ut);snackBar=E(rt);constructor(){this.reloadProviders()}reloadProviders(){return m(this,null,function*(){this.isLoading.set(!0),this.loadError.set(null);try{let e=this.registry.listProviders();if(!e.length){this.providers.set([]);return}let t=yield Promise.all(e.map(n=>this.buildProviderState(n)));this.providers.set(t.sort((n,r)=>n.title.localeCompare(r.title)))}catch(e){this.loadError.set(this.describeError(e))}finally{this.isLoading.set(!1)}})}statusLabel(e){return this.statusLabels[e]}statusClass(e){return`sync-account__status-dot--${e}`}trackByProvider(e,t){return t.id}trackByBackup(e,t){return t.id}connect(e){return m(this,null,function*(){if(e.connected)return;let t=this.registry.getProvider(e.id);if(!t){this.pushError(e.id,"\u041F\u0440\u043E\u0432\u0430\u0439\u0434\u0435\u0440 \u043D\u0435 \u043D\u0430\u0441\u0442\u0440\u043E\u0435\u043D, \u0443\u043A\u0430\u0436\u0438\u0442\u0435 Client ID \u0432 \u043D\u0430\u0441\u0442\u0440\u043E\u0439\u043A\u0430\u0445.");return}this.markStatus(e.id,"syncing");try{yield t.login(),this.showMessage("\u0410\u0432\u0442\u043E\u0440\u0438\u0437\u0430\u0446\u0438\u044F \u0432\u044B\u043F\u043E\u043B\u043D\u0435\u043D\u0430."),yield this.refreshProvider(e.id,t)}catch(n){let r=this.describeError(n);this.pushError(e.id,`\u0412\u0445\u043E\u0434 \u043D\u0435 \u0432\u044B\u043F\u043E\u043B\u043D\u0435\u043D: ${r}`),this.showMessage(r,!0),this.markStatus(e.id,"error")}})}disconnect(e){return m(this,null,function*(){if(!e.connected)return;let t=this.registry.getProvider(e.id);if(t){this.markStatus(e.id,"syncing");try{yield t.logout(),this.showMessage("\u0412\u044B \u0432\u044B\u0448\u043B\u0438 \u0438\u0437 \u0430\u043A\u043A\u0430\u0443\u043D\u0442\u0430.")}catch(n){let r=this.describeError(n);this.pushError(e.id,`\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u044B\u0439\u0442\u0438: ${r}`),this.showMessage(r,!0)}finally{yield this.refreshProvider(e.id,t)}}})}triggerUpload(e){return m(this,null,function*(){yield this.performSync(e,"upload",(t,n)=>m(this,null,function*(){yield this.syncService.twoWaySync(t,n,"upload")}))})}triggerDownload(e){return m(this,null,function*(){if(!e.backups.length){this.showMessage("\u041D\u0435\u0442 \u0440\u0435\u0437\u0435\u0440\u0432\u043D\u044B\u0445 \u043A\u043E\u043F\u0438\u0439 \u0434\u043B\u044F \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438.");return}yield this.performSync(e,"download",(t,n)=>m(this,null,function*(){yield this.syncService.twoWaySync(t,n,"download")}))})}restoreBackup(e,t){return m(this,null,function*(){yield this.performSync(e,"restore",(n,r)=>m(this,null,function*(){let c=yield n.downloadBackup(t.id);yield this.syncService.importBackup(c,r)}))})}deleteBackup(e,t){return m(this,null,function*(){let n=this.registry.getProvider(e.id);if(!n){this.pushError(e.id,"\u041F\u0440\u043E\u0432\u0430\u0439\u0434\u0435\u0440 \u043D\u0435 \u043D\u0430\u0441\u0442\u0440\u043E\u0435\u043D.");return}this.markStatus(e.id,"syncing");try{yield n.deleteBackup(t.id),this.showMessage(`\u0420\u0435\u0437\u0435\u0440\u0432\u043D\u0430\u044F \u043A\u043E\u043F\u0438\u044F ${t.name} \u0443\u0434\u0430\u043B\u0435\u043D\u0430.`)}catch(r){let c=this.describeError(r);this.pushError(e.id,`\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0443\u0434\u0430\u043B\u0438\u0442\u044C \u043A\u043E\u043F\u0438\u044E: ${c}`),this.showMessage(c,!0)}finally{yield this.refreshProvider(e.id,n)}})}performSync(e,t,n){return m(this,null,function*(){if(!e.connected){this.showMessage("\u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u0432\u044B\u043F\u043E\u043B\u043D\u0438\u0442\u0435 \u0432\u0445\u043E\u0434 \u0432 \u0430\u043A\u043A\u0430\u0443\u043D\u0442.");return}let r=this.registry.getProvider(e.id);if(!r){this.pushError(e.id,"\u041F\u0440\u043E\u0432\u0430\u0439\u0434\u0435\u0440 \u043D\u0435 \u043D\u0430\u0441\u0442\u0440\u043E\u0435\u043D.");return}let c=e.status;this.markStatus(e.id,"syncing");let l=this.requestPassphrase(t);if(!l){this.markStatus(e.id,c),this.showMessage("\u0414\u0435\u0439\u0441\u0442\u0432\u0438\u0435 \u043E\u0442\u043C\u0435\u043D\u0435\u043D\u043E.");return}try{yield n(r,l),this.showMessage("\u0421\u0438\u043D\u0445\u0440\u043E\u043D\u0438\u0437\u0430\u0446\u0438\u044F \u0437\u0430\u0432\u0435\u0440\u0448\u0435\u043D\u0430.")}catch(y){let f=this.describeError(y);this.pushError(e.id,`\u041E\u0448\u0438\u0431\u043A\u0430 \u043E\u043F\u0435\u0440\u0430\u0446\u0438\u0438: ${f}`),this.showMessage(f,!0),this.markStatus(e.id,"error");return}yield this.refreshProvider(e.id,r,!0)})}refreshProvider(e,t,n=!1){return m(this,null,function*(){try{let r=yield this.buildProviderState(t);n&&(r.lastSync=new Date().toISOString()),this.providers.update(c=>[...c.filter(y=>y.id!==e),r].sort((y,f)=>y.title.localeCompare(f.title)))}catch(r){let c=this.describeError(r);this.pushError(e,`\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0431\u043D\u043E\u0432\u0438\u0442\u044C \u0441\u043E\u0441\u0442\u043E\u044F\u043D\u0438\u0435: ${c}`),this.markStatus(e,"error")}})}buildProviderState(e){return m(this,null,function*(){let t=!1,n=null,r=[];try{t=yield e.isAuthenticated(),n=t?yield e.getAuthState():null}catch(l){r.push(`\u041F\u0440\u043E\u0432\u0435\u0440\u043A\u0430 \u0441\u0442\u0430\u0442\u0443\u0441\u0430: ${this.describeError(l)}`)}let c=[];if(t)try{c=(yield e.listBackups()).sort((y,f)=>f.modified-y.modified).map(y=>({id:y.id,name:y.name,modified:new Date(y.modified).toISOString(),sizeBytes:y.size,sizeLabel:z(y.size)}))}catch(l){r.push(`\u0421\u043F\u0438\u0441\u043E\u043A \u0440\u0435\u0437\u0435\u0440\u0432\u043D\u044B\u0445 \u043A\u043E\u043F\u0438\u0439: ${this.describeError(l)}`)}return{id:e.id,title:e.label,description:this.descriptions[e.id]??e.label,connected:t,status:r.length?"error":t?"connected":"offline",lastSync:t&&c.length?c[0].modified:void 0,recentErrors:r.slice(0,qt),backups:c,user:n?.user}})}markStatus(e,t){this.providers.update(n=>n.map(r=>r.id===e?lt(st({},r),{status:t}):r))}pushError(e,t){let n=new Date().toISOString();this.providers.update(r=>r.map(c=>c.id===e?lt(st({},c),{status:"error",recentErrors:[`${n} \u2014 ${t}`,...c.recentErrors].slice(0,qt)}):c))}requestPassphrase(e){if(typeof window>"u")return null;let n=`\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u043C\u0430\u0441\u0442\u0435\u0440-\u043F\u0430\u0440\u043E\u043B\u044C \u0434\u043B\u044F ${{upload:"\u0432\u044B\u0433\u0440\u0443\u0437\u043A\u0438 \u0434\u0430\u043D\u043D\u044B\u0445",download:"\u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 \u0434\u0430\u043D\u043D\u044B\u0445",restore:"\u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u044F \u0438\u0437 \u043A\u043E\u043F\u0438\u0438",delete:"\u0443\u0434\u0430\u043B\u0435\u043D\u0438\u044F \u043A\u043E\u043F\u0438\u0438",login:"\u0430\u0432\u0442\u043E\u0440\u0438\u0437\u0430\u0446\u0438\u0438",logout:"\u0432\u044B\u0445\u043E\u0434\u0430 \u0438\u0437 \u0430\u043A\u043A\u0430\u0443\u043D\u0442\u0430"}[e]??"\u043E\u043F\u0435\u0440\u0430\u0446\u0438\u0438"}`,r=window.prompt(n);return r&&r.trim().length>0?r.trim():null}showMessage(e,t=!1){this.snackBar.open(e,"OK",{duration:4e3,panelClass:t?["sync-account__snackbar-error"]:void 0})}describeError(e){if(e instanceof Error&&e.message)return e.message;if(typeof e=="string")return e;try{return JSON.stringify(e)}catch{return"\u041D\u0435\u0438\u0437\u0432\u0435\u0441\u0442\u043D\u0430\u044F \u043E\u0448\u0438\u0431\u043A\u0430"}}static \u0275fac=function(t){return new(t||i)};static \u0275cmp=k({type:i,selectors:[["app-sync-account"]],decls:8,vars:2,consts:[["loaded",""],["empty",""],["errorTpl",""],["aria-label","\u0421\u043F\u0438\u0441\u043E\u043A \u043E\u0431\u043B\u0430\u0447\u043D\u044B\u0445 \u043F\u0440\u043E\u0432\u0430\u0439\u0434\u0435\u0440\u043E\u0432",1,"sync-account"],[4,"ngIf","ngIfElse"],[1,"sync-account__card"],[1,"sync-account__state"],["class","sync-account__card",4,"ngFor","ngForOf","ngForTrackBy"],[1,"sync-account__status"],["aria-hidden","true",1,"sync-account__status-dot",3,"ngClass"],[1,"sync-account__status-label"],["class","sync-account__status-sync",4,"ngIf"],[3,"id"],[4,"ngIf"],[1,"sync-account__controls"],["mat-stroked-button","","color","primary",3,"click",4,"ngIf"],["mat-stroked-button","","color","warn",3,"click",4,"ngIf"],["mat-stroked-button","",3,"click","disabled"],["class","sync-account__backups",4,"ngIf"],["class","sync-account__errors",4,"ngIf"],[1,"sync-account__status-sync"],["mat-stroked-button","","color","primary",3,"click"],["mat-stroked-button","","color","warn",3,"click"],[1,"sync-account__backups"],[1,"sync-account__section-header"],[4,"ngFor","ngForOf","ngForTrackBy"],[1,"sync-account__backup"],[1,"sync-account__backup-info"],[1,"sync-account__backup-name"],[1,"sync-account__backup-meta"],[1,"sync-account__backup-actions"],["mat-button","",3,"click","disabled"],["mat-button","","color","warn",3,"click","disabled"],[1,"sync-account__errors"],[4,"ngFor","ngForOf"],[1,"sync-account__state","sync-account__state--error"]],template:function(t,n){if(t&1&&(a(0,"section",3),_(1,fe,4,0,"ng-container",4),o(),_(2,Pe,2,2,"ng-template",null,0,x)(4,Me,3,0,"ng-template",null,1,x)(6,Ae,3,1,"ng-template",null,2,x)),t&2){let r=b(3);s(),d("ngIf",n.isLoading())("ngIfElse",r)}},dependencies:[D,vt,M,A,R,It,Ot,Ft,$,Tt,Nt,Lt,V,K],styles:[".sync-account[_ngcontent-%COMP%]{display:grid;gap:1.5rem}.sync-account__card[_ngcontent-%COMP%]{display:block}.sync-account__status[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem;margin-bottom:.75rem;font-size:.875rem;color:#0000008a}.sync-account__status-dot[_ngcontent-%COMP%]{width:.75rem;height:.75rem;border-radius:50%;background-color:#00000042;display:inline-block}.sync-account__status-dot--connected[_ngcontent-%COMP%]{background-color:#2e7d32}.sync-account__status-dot--syncing[_ngcontent-%COMP%]{background:repeating-linear-gradient(45deg,#1976d2,#1976d2 4px,#64b5f6 4px 8px)}.sync-account__status-dot--error[_ngcontent-%COMP%]{background-color:#c62828}.sync-account__status-dot--offline[_ngcontent-%COMP%]{background-color:#00000042}.sync-account__status-label[_ngcontent-%COMP%]{font-weight:600}.sync-account__status-sync[_ngcontent-%COMP%]{margin-left:auto;white-space:nowrap}.sync-account__controls[_ngcontent-%COMP%]{display:flex;flex-wrap:wrap;gap:.5rem;margin-bottom:1.5rem}.sync-account__backups[_ngcontent-%COMP%]   mat-list-item[_ngcontent-%COMP%]{height:auto!important;padding:.5rem 0}.sync-account__backup[_ngcontent-%COMP%]{display:flex;flex-wrap:wrap;width:100%;gap:.75rem;justify-content:space-between;align-items:center}.sync-account__backup-info[_ngcontent-%COMP%]{min-width:12rem}.sync-account__backup-name[_ngcontent-%COMP%]{display:block;font-weight:600}.sync-account__backup-meta[_ngcontent-%COMP%]{font-size:.8125rem;color:#0000008a}.sync-account__backup-actions[_ngcontent-%COMP%]{display:flex;gap:.5rem}.sync-account__errors[_ngcontent-%COMP%]{margin-top:1.5rem}.sync-account__errors[_ngcontent-%COMP%]   ul[_ngcontent-%COMP%]{margin:.5rem 0 0;padding-left:1.25rem;color:#c62828}.sync-account__section-header[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem;margin-bottom:.5rem}.sync-account__section-header[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0;font-size:1rem;font-weight:600}.sync-account__state[_ngcontent-%COMP%]{margin:1rem 0 0;color:#0000008a}.sync-account__state--error[_ngcontent-%COMP%]{color:#c62828}.sync-account__snackbar-error[_ngcontent-%COMP%]{color:#fff!important;background:#c62828!important}"],changeDetection:0})};var Fe=[{path:"",component:ot,children:[{path:"",pathMatch:"full",redirectTo:"list"},{path:"list",component:j},{path:"create",component:T},{path:"accounts",component:H},{path:"last-restore",component:L},{path:":id/edit",component:T},{path:":id",component:L}]}],ct=class i{static \u0275fac=function(t){return new(t||i)};static \u0275mod=Z({type:i});static \u0275inj=Y({imports:[dt.forChild(Fe),dt]})};var Qt=class i{static \u0275fac=function(t){return new(t||i)};static \u0275mod=Z({type:i});static \u0275inj=Y({imports:[D,ct,j,T,L,H]})};export{Qt as SyncModule};
