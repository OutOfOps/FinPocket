import{b as E}from"./chunk-6HSA32IX.js";import{a as u,b as g,f as s,w as m,z as _}from"./chunk-X6DWFC4Y.js";function I(){return s(this,null,function*(){let a=new Uint8Array(32);return crypto.getRandomValues(a),C(a)})}function b(a){return s(this,null,function*(){let t=new TextEncoder().encode(a),r=yield crypto.subtle.digest("SHA-256",t);return C(new Uint8Array(r))})}function C(a){return btoa(String.fromCharCode(...a)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}var y=class extends E{constructor(){super("auth.gdrive"),this.version(1).stores({tokens:"&id"})}},k=/^[a-zA-Z0-9-]+\.apps\.googleusercontent\.com$/,G="https://accounts.google.com/o/oauth2/v2/auth",U="https://oauth2.googleapis.com/token",f="https://www.googleapis.com/drive/v3/files",O="https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart",F="https://www.googleapis.com/drive/v3/about?fields=user",w="tokens",P="FinPocket",V="https://www.googleapis.com/auth/drive.file";function T(){return"https://outofops.github.io/FinPocket/auth/callback/gdrive/"}var R=class{constructor(e){this.options=e}id="gdrive";label="Google Drive";db=new y;quotaToastVisible=!1;cachedRecord=null;isAuthenticated(){return s(this,null,function*(){try{return yield this.getAccessToken(),!0}catch(e){return console.warn("[GDrive] isAuthenticated check failed",e),!1}})}getAuthState(){return s(this,null,function*(){let e=yield this.getTokenRecord();return e?{provider:"gdrive",user:e.user,accessToken:e.accessToken,refreshToken:e.refreshToken,expiresAt:e.expiresAt}:null})}login(){return s(this,null,function*(){if(typeof window>"u")throw new Error("OAuth login is only available in browser environments");let e=this.requireClientId(),t=yield I(),r=yield b(t),o=this.generateState(),i=this.validateRedirectUri(this.buildRedirectUri());this.storeAuthContext(o,{verifier:t,redirectUri:i,clientId:e});let n=new URL(G);n.searchParams.set("client_id",e),n.searchParams.set("redirect_uri",i),n.searchParams.set("response_type","code"),n.searchParams.set("scope",V),n.searchParams.set("state",o),n.searchParams.set("code_challenge",r),n.searchParams.set("code_challenge_method","S256"),n.searchParams.set("access_type","offline"),n.searchParams.set("prompt","consent");let l=window.open(n.toString(),"gdrive-oauth","popup=yes,width=600,height=700");if(!l)throw new Error("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C \u043E\u043A\u043D\u043E \u0430\u0432\u0442\u043E\u0440\u0438\u0437\u0430\u0446\u0438\u0438 Google");try{yield this.waitForAuthCompletion(l,o)}finally{this.clearAuthContext(o)}let{record:c}=yield this.getAccessToken(),d=c;if(!c.user)try{let p=yield this.fetchUserProfile(c.accessToken);p&&(d=g(u({},c),{user:p}),yield this.saveTokenRecord(d))}catch(p){console.warn("[GDrive] Failed to fetch user profile after login",p)}return{provider:"gdrive",user:d.user,accessToken:d.accessToken,refreshToken:d.refreshToken,expiresAt:d.expiresAt}})}logout(){return s(this,null,function*(){yield this.db.tokens.delete(w),this.cachedRecord=null})}ensureAppFolder(){return s(this,null,function*(){let{token:e,record:t}=yield this.getAccessToken();if(t.appFolderId)return t.appFolderId;let r=yield this.findOrCreateAppFolder(e),o=g(u({},t),{appFolderId:r});return yield this.saveTokenRecord(o),r})}listBackups(){return s(this,null,function*(){let e=yield this.ensureAppFolder(),{token:t}=yield this.getAccessToken(),r=new URL(f);r.searchParams.set("q",`('${e}' in parents) and trashed = false and name contains '.finpocket.json.enc'`),r.searchParams.set("orderBy","modifiedTime desc"),r.searchParams.set("fields","files(id,name,size,modifiedTime)"),r.searchParams.set("pageSize","100");let o=yield this.fetchWithAuth(r.toString(),t);if(!o.ok)throw new Error("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u043E\u043B\u0443\u0447\u0438\u0442\u044C \u0441\u043F\u0438\u0441\u043E\u043A \u0440\u0435\u0437\u0435\u0440\u0432\u043D\u044B\u0445 \u043A\u043E\u043F\u0438\u0439 Google Drive");return(yield o.json()).files?.map(n=>({id:n.id,name:n.name,size:Number(n.size??0),modified:n.modifiedTime?new Date(n.modifiedTime).getTime():0}))??[]})}downloadBackup(e){return s(this,null,function*(){let{token:t}=yield this.getAccessToken(),r=`${f}/${encodeURIComponent(e)}?alt=media`,o=yield this.fetchWithAuth(r,t);if(!o.ok)throw new Error("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043A\u0430\u0447\u0430\u0442\u044C \u0440\u0435\u0437\u0435\u0440\u0432\u043D\u0443\u044E \u043A\u043E\u043F\u0438\u044E Google Drive");return o.blob()})}uploadBackup(e,t){return s(this,null,function*(){let r=yield this.ensureAppFolder(),{token:o}=yield this.getAccessToken(),i={name:e,parents:[r],mimeType:"application/octet-stream"},n=new FormData;n.append("metadata",new Blob([JSON.stringify(i)],{type:"application/json; charset=UTF-8"})),n.append("file",t,e);let l=yield fetch(O,{method:"POST",headers:{Authorization:`Bearer ${o}`},body:n});if(!l.ok)throw new Error("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0440\u0435\u0437\u0435\u0440\u0432\u043D\u0443\u044E \u043A\u043E\u043F\u0438\u044E \u043D\u0430 Google Drive");let c=yield l.json();return{id:c.id,name:c.name,modified:c.modifiedTime?new Date(c.modifiedTime).getTime():Date.now()}})}deleteBackup(e){return s(this,null,function*(){let{token:t}=yield this.getAccessToken(),r=`${f}/${encodeURIComponent(e)}`;if(!(yield fetch(r,{method:"DELETE",headers:{Authorization:`Bearer ${t}`}})).ok)throw new Error("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0443\u0434\u0430\u043B\u0438\u0442\u044C \u0440\u0435\u0437\u0435\u0440\u0432\u043D\u0443\u044E \u043A\u043E\u043F\u0438\u044E Google Drive")})}getTokenRecord(){return s(this,null,function*(){if(this.cachedRecord)return this.cachedRecord;let e=yield this.db.tokens.get(w);return this.cachedRecord=e??null,this.cachedRecord})}saveTokenRecord(e){return s(this,null,function*(){yield this.db.tokens.put(g(u({},e),{id:w})),this.cachedRecord=e})}getAccessToken(){return s(this,null,function*(){let e=yield this.ensureToken();return{token:e.accessToken,record:e}})}ensureToken(){return s(this,null,function*(){let e=yield this.getTokenRecord();if(!e||!e.accessToken)throw new Error("Google Drive \u043D\u0435 \u0430\u0432\u0442\u043E\u0440\u0438\u0437\u043E\u0432\u0430\u043D");if(!e.expiresAt||Date.now()<=e.expiresAt-6e4)return e;if(!e.refreshToken)throw yield this.logout(),new Error("\u0421\u0440\u043E\u043A \u0434\u0435\u0439\u0441\u0442\u0432\u0438\u044F \u0442\u043E\u043A\u0435\u043D\u0430 Google Drive \u0438\u0441\u0442\u0451\u043A, \u0442\u0440\u0435\u0431\u0443\u0435\u0442\u0441\u044F \u043F\u043E\u0432\u0442\u043E\u0440\u043D\u044B\u0439 \u0432\u0445\u043E\u0434");let t=yield this.refreshAccessToken(e.refreshToken);if(!t||!t.access_token)throw yield this.logout(),new Error("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0431\u043D\u043E\u0432\u0438\u0442\u044C \u0442\u043E\u043A\u0435\u043D Google Drive, \u0442\u0440\u0435\u0431\u0443\u0435\u0442\u0441\u044F \u043F\u043E\u0432\u0442\u043E\u0440\u043D\u0430\u044F \u0430\u0432\u0442\u043E\u0440\u0438\u0437\u0430\u0446\u0438\u044F");let r=g(u({},e),{accessToken:t.access_token,expiresAt:this.computeExpiry(t.expires_in),scope:t.scope??e.scope,tokenType:t.token_type??e.tokenType});return t.refresh_token&&(r.refreshToken=t.refresh_token),yield this.saveTokenRecord(r),r})}refreshAccessToken(e){return s(this,null,function*(){let t=new URLSearchParams;return t.set("client_id",this.requireClientId()),t.set("grant_type","refresh_token"),t.set("refresh_token",e),this.requestToken(t)})}fetchUserProfile(e){return s(this,null,function*(){let t=yield fetch(F,{headers:{Authorization:`Bearer ${e}`}});if(!t.ok)return;let r=yield t.json();if(r.user)return{id:r.user.permissionId??"me",name:r.user.displayName,email:r.user.emailAddress}})}findOrCreateAppFolder(e){return s(this,null,function*(){let t=yield this.findAppFolder(e);if(t)return t;let r=yield fetch(f,{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json; charset=UTF-8"},body:JSON.stringify({name:P,mimeType:"application/vnd.google-apps.folder"})});if(!r.ok)throw new Error("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0437\u0434\u0430\u0442\u044C \u043F\u0430\u043F\u043A\u0443 \u043F\u0440\u0438\u043B\u043E\u0436\u0435\u043D\u0438\u044F \u0432 Google Drive");return(yield r.json()).id})}findAppFolder(e){return s(this,null,function*(){let t=new URL(f);t.searchParams.set("q",`mimeType = 'application/vnd.google-apps.folder' and trashed = false and name = '${P}'`),t.searchParams.set("fields","files(id)"),t.searchParams.set("pageSize","1");let r=yield this.fetchWithAuth(t.toString(),e);return r.ok?(yield r.json()).files?.[0]?.id??null:null})}fetchWithAuth(e,t,r){let o=new Headers(r?.headers??{});return o.set("Authorization",`Bearer ${t}`),fetch(e,g(u({},r),{headers:o}))}computeExpiry(e){if(e)return Date.now()+e*1e3}generateState(){let e=new Uint8Array(16);return crypto.getRandomValues(e),Array.from(e,t=>t.toString(16).padStart(2,"0")).join("")}buildRedirectUri(){return T()}requireClientId(){let e=this.normalizeClientId(this.options.clientId);if(!e)throw new Error("Client ID Google Drive \u043D\u0435 \u043D\u0430\u0441\u0442\u0440\u043E\u0435\u043D. \u0423\u043A\u0430\u0436\u0438\u0442\u0435 \u0437\u043D\u0430\u0447\u0435\u043D\u0438\u0435 \u0438\u0437 Google Cloud Console \u0432 \u043D\u0430\u0441\u0442\u0440\u043E\u0439\u043A\u0430\u0445 \u0441\u0438\u043D\u0445\u0440\u043E\u043D\u0438\u0437\u0430\u0446\u0438\u0438.");if(!k.test(e))throw new Error("Client ID Google Drive \u0438\u043C\u0435\u0435\u0442 \u043D\u0435\u0432\u0435\u0440\u043D\u044B\u0439 \u0444\u043E\u0440\u043C\u0430\u0442. \u0418\u0441\u043F\u043E\u043B\u044C\u0437\u0443\u0439\u0442\u0435 \u0438\u0434\u0435\u043D\u0442\u0438\u0444\u0438\u043A\u0430\u0442\u043E\u0440 \u0432\u0438\u0434\u0430 12345-abc.apps.googleusercontent.com.");return this.options.clientId=e,e}normalizeClientId(e){return e?e.trim().replace(/^['"]+|['"]+$/g,"").replace(/\s+/g,""):""}validateRedirectUri(e){let t;try{t=new URL(e)}catch{throw new Error("\u041D\u0435\u043A\u043E\u0440\u0440\u0435\u043A\u0442\u043D\u044B\u0439 redirect_uri \u0434\u043B\u044F \u0430\u0432\u0442\u043E\u0440\u0438\u0437\u0430\u0446\u0438\u0438 Google Drive. \u041F\u0440\u043E\u0432\u0435\u0440\u044C\u0442\u0435 \u043D\u0430\u0441\u0442\u0440\u043E\u0439\u043A\u0438 \u043F\u0440\u0438\u043B\u043E\u0436\u0435\u043D\u0438\u044F \u0438 \u0441\u043A\u043E\u043F\u0438\u0440\u0443\u0439\u0442\u0435 \u0430\u0434\u0440\u0435\u0441 \u043F\u0435\u0440\u0435\u043D\u0430\u043F\u0440\u0430\u0432\u043B\u0435\u043D\u0438\u044F \u0437\u0430\u043D\u043E\u0432\u043E.")}if(t.protocol==="https:"||t.protocol==="http:"&&new Set(["localhost","127.0.0.1","[::1]","::1"]).has(t.hostname))return t.toString();throw new Error("\u0410\u0434\u0440\u0435\u0441 \u043F\u0435\u0440\u0435\u043D\u0430\u043F\u0440\u0430\u0432\u043B\u0435\u043D\u0438\u044F Google Drive \u0434\u043E\u043B\u0436\u0435\u043D \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u044C HTTPS. \u0414\u043B\u044F \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u043E\u0439 \u0440\u0430\u0437\u0440\u0430\u0431\u043E\u0442\u043A\u0438 \u0434\u043E\u043F\u0443\u0441\u0442\u0438\u043C \u0442\u043E\u043B\u044C\u043A\u043E http://localhost.")}waitForAuthCompletion(e,t){return new Promise((r,o)=>{let i=c=>{if(c.origin!==window.location.origin)return;let d=c.data;if(!(!d||d.provider!=="gdrive")){if(d.state!==t){o(new Error("\u0421\u043E\u0441\u0442\u043E\u044F\u043D\u0438\u0435 OAuth \u043D\u0435 \u0441\u043E\u0432\u043F\u0430\u0434\u0430\u0435\u0442")),l();return}if(d.status!=="success"){o(new Error(d.error??"\u0410\u0432\u0442\u043E\u0440\u0438\u0437\u0430\u0446\u0438\u044F Google Drive \u043D\u0435 \u0443\u0434\u0430\u043B\u0430\u0441\u044C")),l();return}r(),l()}},n=window.setInterval(()=>{e.closed&&(o(new Error("\u041E\u043A\u043D\u043E \u0430\u0432\u0442\u043E\u0440\u0438\u0437\u0430\u0446\u0438\u0438 Google \u0437\u0430\u043A\u0440\u044B\u0442\u043E \u0434\u043E \u0437\u0430\u0432\u0435\u0440\u0448\u0435\u043D\u0438\u044F \u0432\u0445\u043E\u0434\u0430")),l())},500),l=()=>{window.removeEventListener("message",i),window.clearInterval(n)};window.addEventListener("message",i)})}storeAuthContext(e,t){if(!(typeof window>"u"))try{let r={verifier:t.verifier,redirectUri:t.redirectUri,clientId:t.clientId,createdAt:Date.now()};window.localStorage.setItem(this.buildAuthContextKey(e),JSON.stringify(r))}catch(r){console.warn("[GDrive] Failed to persist auth context",r)}}clearAuthContext(e){if(!(typeof window>"u"))try{window.localStorage.removeItem(this.buildAuthContextKey(e))}catch(t){console.warn("[GDrive] Failed to clear auth context",t)}}buildAuthContextKey(e){return z(e)}requestToken(e){return s(this,null,function*(){let r=0,o=1e3;for(;r<3;){r+=1;try{let i=yield fetch(U,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:e.toString()});if(i.ok)return i.json();if(i.status===403)return this.showQuotaExceededToast(),null;if((i.status===429||i.status>=500&&i.status<600)&&r<3){yield this.delay(o),o*=2;continue}let n=yield i.text().catch(()=>"");throw new Error(`Google Drive token request failed with status ${i.status}. ${n}`)}catch(i){if(r>=3)throw i;yield this.delay(o),o*=2}}return null})}delay(e){return s(this,null,function*(){return new Promise(t=>setTimeout(t,e))})}showQuotaExceededToast(){if(typeof document>"u"){console.warn("[GDrive] Received quota exceeded response but cannot show toast outside browser context");return}if(this.quotaToastVisible)return;this.quotaToastVisible=!0;let e=document.createElement("div");e.textContent="Google Drive \u0432\u0440\u0435\u043C\u0435\u043D\u043D\u043E \u0438\u0441\u0447\u0435\u0440\u043F\u0430\u043B \u043A\u0432\u043E\u0442\u0443. \u041F\u043E\u0432\u0442\u043E\u0440\u0438\u0442\u0435 \u043F\u043E\u043F\u044B\u0442\u043A\u0443 \u0447\u0435\u0440\u0435\u0437 \u043D\u0435\u0441\u043A\u043E\u043B\u044C\u043A\u043E \u043C\u0438\u043D\u0443\u0442.",e.style.position="fixed",e.style.left="50%",e.style.bottom="24px",e.style.transform="translateX(-50%)",e.style.background="rgba(50, 50, 50, 0.95)",e.style.color="#fff",e.style.padding="12px 20px",e.style.borderRadius="8px",e.style.boxShadow="0 2px 10px rgba(0, 0, 0, 0.2)",e.style.zIndex="10000",e.style.fontSize="14px",e.style.fontFamily="Roboto, Arial, sans-serif",e.style.maxWidth="320px",e.style.textAlign="center",e.style.transition="opacity 300ms ease",e.style.opacity="1",document.body.appendChild(e),setTimeout(()=>{e.style.opacity="0",setTimeout(()=>{e.remove(),this.quotaToastVisible=!1},300)},5e3)}},N="gdrive:oauth:";function z(a){return`${N}${a}`}var D="finpocket.sync.settings.v1",A=1,v=class a{getEncryptionEnabled(){return this.read().encryptionEnabled??!0}setEncryptionEnabled(e){let t=this.read();t.encryptionEnabled=e,this.write(t)}getGoogleDriveClientId(){let e=this.read().providers.gdrive?.clientId,t=e?this.normalizeGoogleDriveClientId(e):void 0;return t&&t.length>0?t:this.resolveClientIdFromEnvironment()}setGoogleDriveClientId(e){let t=this.read();if(!e)delete t.providers.gdrive?.clientId,t.providers.gdrive||(t.providers.gdrive={});else{let r=this.normalizeGoogleDriveClientId(e);if(!r){delete t.providers.gdrive?.clientId,t.providers.gdrive||(t.providers.gdrive={}),this.write(t);return}t.providers.gdrive||(t.providers.gdrive={}),t.providers.gdrive.clientId=r}this.write(t)}read(){if(typeof window>"u")return this.empty();try{let e=window.localStorage.getItem(D);if(!e)return this.empty();let t=JSON.parse(e);return!t||t.version!==A||!t.providers?this.empty():{version:A,encryptionEnabled:t.encryptionEnabled,providers:t.providers}}catch{return this.empty()}}write(e){if(!(typeof window>"u"))try{window.localStorage.setItem(D,JSON.stringify(e))}catch{}}empty(){return{version:A,providers:{gdrive:{},onedrive:{},dropbox:{}},encryptionEnabled:!0}}resolveClientIdFromEnvironment(){let e=globalThis,t=[e?.finPocketConfig?.gdriveClientId,e?.finPocketEnv?.gdriveClientId,e?.FINPOCKET_GDRIVE_CLIENT_ID,e?.NG_APP_GDRIVE_CLIENT_ID];for(let r of t){let o=this.normalizeCandidate(r);if(o)return o}if(typeof document<"u"){let o=document.querySelector('meta[name="finpocket-gdrive-client-id"]')?.getAttribute("content"),i=this.normalizeCandidate(o);if(i)return i}}normalizeCandidate(e){if(typeof e=="string"){let t=this.normalizeGoogleDriveClientId(e);if(t.length>0)return t}}normalizeGoogleDriveClientId(e){return e.trim().replace(/^['"]+|['"]+$/g,"").replace(/\s+/g,"")}static \u0275fac=function(t){return new(t||a)};static \u0275prov=m({token:a,factory:a.\u0275fac,providedIn:"root"})};var h="gdrive_code_verifier",S="gdrive_tokens",q="https://accounts.google.com/o/oauth2/v2/auth",B=600*1e3,x=class a{constructor(e){this.settings=e}scope="https://www.googleapis.com/auth/drive.file";tokenEndpoint="https://oauth2.googleapis.com/token";startAuthFlow(){return s(this,null,function*(){if(typeof window>"u"||typeof window.crypto>"u")throw new Error("OAuth 2.0 \u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D \u0442\u043E\u043B\u044C\u043A\u043E \u0432 \u0431\u0440\u0430\u0443\u0437\u0435\u0440\u0435.");let e=this.getClientIdOrThrow(),t=this.getRedirectUri(),r=this.generateCodeVerifier();this.storeCodeVerifier(r);let o=yield this.generateCodeChallenge(r),i=this.generateState(),n=new URL(q);n.searchParams.set("client_id",e),n.searchParams.set("redirect_uri",t),n.searchParams.set("response_type","code"),n.searchParams.set("scope",this.scope),n.searchParams.set("access_type","offline"),n.searchParams.set("include_granted_scopes","true"),n.searchParams.set("prompt","consent"),n.searchParams.set("code_challenge",o),n.searchParams.set("code_challenge_method","S256"),n.searchParams.set("state",i),window.location.href=n.toString()})}generateCodeVerifier(){let e=globalThis.crypto;if(!e||typeof e.getRandomValues!="function")throw new Error("Web Crypto API \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D");let t=new Uint8Array(64);return e.getRandomValues(t),this.base64UrlEncode(t)}generateCodeChallenge(e){return s(this,null,function*(){let t=globalThis.crypto;if(!t||!t.subtle||typeof t.subtle.digest!="function")throw new Error("Web Crypto API \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D");let o=new TextEncoder().encode(e),i=yield t.subtle.digest("SHA-256",o);return this.base64UrlEncode(new Uint8Array(i))})}exchangeCodeForToken(e){return s(this,null,function*(){let t=this.restoreCodeVerifier();if(!t)throw new Error("\u041A\u043E\u0434 \u043F\u043E\u0434\u0442\u0432\u0435\u0440\u0436\u0434\u0435\u043D\u0438\u044F PKCE \u043E\u0442\u0441\u0443\u0442\u0441\u0442\u0432\u0443\u0435\u0442. \u041F\u043E\u0432\u0442\u043E\u0440\u0438\u0442\u0435 \u0430\u0432\u0442\u043E\u0440\u0438\u0437\u0430\u0446\u0438\u044E.");let r=this.getClientIdOrThrow(),o=this.getRedirectUri(),i=new URLSearchParams({client_id:r,grant_type:"authorization_code",code:e,code_verifier:t,redirect_uri:o});console.group("%c[OAuth] \u041E\u0431\u043C\u0435\u043D \u043A\u043E\u0434\u0430 \u043D\u0430 \u0442\u043E\u043A\u0435\u043D","color:#03A9F4"),console.log("client_id:",r),console.log("redirect_uri:",o),console.log("code_verifier (len):",t.length),console.log("payload:",i.toString()),console.groupEnd();let n=yield fetch(this.tokenEndpoint,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:i.toString()}),l=yield n.text();if(console.log("%c[OAuth] \u041E\u0442\u0432\u0435\u0442 Google:","color:#FFC107",l),!n.ok){console.error("Response status:",n.status,n.statusText);let d="";try{let p=JSON.parse(l);d=`${p.error}: ${p.error_description??""}`}catch{d="\u041E\u0442\u0432\u0435\u0442 \u043D\u0435 JSON, \u0432\u043E\u0437\u043C\u043E\u0436\u043D\u043E 400 Bad Request \u0438\u0437-\u0437\u0430 \u043D\u0435\u043F\u0440\u0430\u0432\u0438\u043B\u044C\u043D\u043E\u0433\u043E \u0442\u0435\u043B\u0430 \u0437\u0430\u043F\u0440\u043E\u0441\u0430."}throw new Error(`\u041E\u0448\u0438\u0431\u043A\u0430 \u043E\u0431\u043C\u0435\u043D\u0430 \u043A\u043E\u0434\u0430 \u043D\u0430 \u0442\u043E\u043A\u0435\u043D Google Drive: ${d}`)}let c;try{c=JSON.parse(l)}catch{throw new Error("\u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u0430\u0440\u0441\u0438\u043D\u0433\u0430 \u043E\u0442\u0432\u0435\u0442\u0430 Google OAuth API.")}if(!c.access_token||!c.expires_in)throw new Error("\u041E\u0442\u0432\u0435\u0442 Google \u043D\u0435 \u0441\u043E\u0434\u0435\u0440\u0436\u0438\u0442 access_token \u0438\u043B\u0438 expires_in.");console.log("%c[OAuth] \u0422\u043E\u043A\u0435\u043D \u0443\u0441\u043F\u0435\u0448\u043D\u043E \u043F\u043E\u043B\u0443\u0447\u0435\u043D!","color:#4CAF50",c),this.saveTokens(c)})}getAccessToken(){let e=this.loadTokens();return!e||Date.now()>=e.expires_at?null:e.access_token}refreshAccessToken(){return s(this,null,function*(){let e=this.loadTokens();if(!e?.refresh_token)return null;let t;try{t=this.getClientIdOrThrow()}catch(o){return console.error("[GDrive] refresh token aborted: client id unavailable",o),this.logout(),null}let r=new URLSearchParams;r.set("client_id",t),r.set("grant_type","refresh_token"),r.set("refresh_token",e.refresh_token);try{let o=yield fetch(this.tokenEndpoint,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:r.toString()});if(!o.ok){let n=yield o.text().catch(()=>"");throw new Error(n?`\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0431\u043D\u043E\u0432\u0438\u0442\u044C \u0442\u043E\u043A\u0435\u043D Google Drive: ${n}`:"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0431\u043D\u043E\u0432\u0438\u0442\u044C \u0442\u043E\u043A\u0435\u043D Google Drive.")}let i=yield o.json();if(!i.access_token||!i.expires_in)throw new Error("\u041E\u0442\u0432\u0435\u0442 \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u044F \u0442\u043E\u043A\u0435\u043D\u0430 Google Drive \u043D\u0435 \u0441\u043E\u0434\u0435\u0440\u0436\u0438\u0442 access_token.");return i.refresh_token||(i.refresh_token=e.refresh_token),this.saveTokens(i),i.access_token}catch(o){return console.error("[GDrive] refresh token failed",o),this.logout(),null}})}logout(){this.clearCodeVerifier(),!(typeof localStorage>"u")&&localStorage.removeItem(S)}saveTokens(e){if(typeof localStorage>"u")return;let t=this.loadTokens(),r=Date.now()+e.expires_in*1e3,o={access_token:e.access_token,refresh_token:e.refresh_token??t?.refresh_token,expires_at:r};localStorage.setItem(S,JSON.stringify(o))}loadTokens(){if(typeof localStorage>"u")return null;let e=localStorage.getItem(S);if(!e)return null;try{return JSON.parse(e)}catch(t){return console.warn("[GDrive] Failed to parse stored tokens",t),null}}ensureTokenValid(){return s(this,null,function*(){let e=this.loadTokens();return e?Date.now()>e.expires_at-6e4?yield this.refreshAccessToken():e.access_token:null})}base64UrlEncode(e){let t="";return e.forEach(r=>{t+=String.fromCharCode(r)}),btoa(t).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}restoreCodeVerifier(){let e=null;try{let t=localStorage.getItem(h);t&&(e=JSON.parse(t))}catch(t){console.warn("[GDrive] Failed to parse PKCE code verifier",t)}return e?Date.now()-e.createdAt>B?(localStorage.removeItem(h),null):e.verifier:null}clearCodeVerifier(){typeof sessionStorage<"u"&&sessionStorage.removeItem(h),typeof localStorage<"u"&&localStorage.removeItem(h)}generateState(){let e=globalThis.crypto;return e&&typeof e.randomUUID=="function"?e.randomUUID():Math.random().toString(36).slice(2,18)}readStoredCodeVerifier(){let e=[typeof sessionStorage<"u"?sessionStorage:void 0,typeof localStorage<"u"?localStorage:void 0];for(let t of e){if(!t)continue;let r=t.getItem(h);if(r)try{let o=JSON.parse(r);if(o&&typeof o.verifier=="string"&&typeof o.createdAt=="number")return o}catch(o){console.warn("[GDrive] Failed to parse stored PKCE code verifier",o)}}return null}storeCodeVerifier(e){let t={verifier:e,createdAt:Date.now()},r=JSON.stringify(t);try{localStorage.setItem(h,r)}catch(o){console.warn("[GDrive] Failed to persist PKCE code verifier",o)}}getClientIdOrThrow(){let e=this.settings.getGoogleDriveClientId();if(!e)throw new Error("Client ID Google Drive \u043D\u0435 \u043D\u0430\u0441\u0442\u0440\u043E\u0435\u043D. \u0423\u043A\u0430\u0436\u0438\u0442\u0435 \u0437\u043D\u0430\u0447\u0435\u043D\u0438\u0435 \u0438\u0437 Google Cloud Console \u0432 \u043D\u0430\u0441\u0442\u0440\u043E\u0439\u043A\u0430\u0445 \u0441\u0438\u043D\u0445\u0440\u043E\u043D\u0438\u0437\u0430\u0446\u0438\u0438.");if(!k.test(e))throw new Error("Client ID Google Drive \u0438\u043C\u0435\u0435\u0442 \u043D\u0435\u0432\u0435\u0440\u043D\u044B\u0439 \u0444\u043E\u0440\u043C\u0430\u0442. \u0418\u0441\u043F\u043E\u043B\u044C\u0437\u0443\u0439\u0442\u0435 \u0438\u0434\u0435\u043D\u0442\u0438\u0444\u0438\u043A\u0430\u0442\u043E\u0440 \u0432\u0438\u0434\u0430 12345-abc.apps.googleusercontent.com.");return e}getRedirectUri(){return T()}static \u0275fac=function(t){return new(t||a)(_(v))};static \u0275prov=m({token:a,factory:a.\u0275fac,providedIn:"root"})};export{k as a,R as b,v as c,x as d};
