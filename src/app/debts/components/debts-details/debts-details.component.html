<div class="debts-details-view">
  @if (debt()) {
  <!-- Header -->
  <header class="details-header">
    <button mat-icon-button (click)="router.navigate(['/debts'])" class="back-btn">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <div class="header-titles">
      <h2>{{ debt()?.contact }}</h2>
      <span class="status-badge" [class]="debt()?.status">
        {{ debtsStore.statusLabel(debt()!.status) }}
      </span>
    </div>
    <button mat-icon-button (click)="removeDebt()" class="delete-btn" title="Удалить долг">
      <mat-icon>delete_outline</mat-icon>
    </button>
  </header>

  <div class="details-content">

    <!-- Hero Balance Card -->
    <div class="hero-card neo-card" [class.negative]="debt()?.direction === 'owed'"
      [class.positive]="debt()?.direction === 'lent'">
      <span class="label">Текущий остаток</span>
      <div class="balance-row">
        <span class="currency">{{ debt()?.currency }}</span>
        <span class="amount">{{ remainingBalance() | number:'1.2-2' }}</span>
      </div>
      <div class="hero-footer">
        <span class="original-label">Начальная сумма:</span>
        <span class="original-amount">{{ formatAmount(debt()!.amount) }}</span>
      </div>
    </div>

    <!-- Management Actions -->
    @if (!isEditing() && !isAddingPayment()) {
    <div class="management-section">
      <button class="action-btn primary" (click)="startAddPayment()" [disabled]="remainingBalance() === 0">
        <mat-icon>payments</mat-icon>
        <span>Внести выплату</span>
      </button>
      <button class="action-btn secondary" (click)="startEdit()">
        <mat-icon>edit</mat-icon>
        <span>Редактировать</span>
      </button>
    </div>
    }

    <!-- Edit Form (Inline) -->
    @if (isEditing()) {
    <div class="form-container neo-card">
      <h3 class="form-title">Редактирование</h3>
      <div class="neo-form">
        <div class="form-group">
          <label>Имя контакта</label>
          <input type="text" [(ngModel)]="editForm().contact" class="neo-input">
        </div>
        <div class="form-row">
          <div class="form-group flex-1">
            <label>Тип</label>
            <select [(ngModel)]="editForm().kind" class="neo-input">
              @for (opt of typeOptions; track opt.value) {
              <option [value]="opt.value">{{ opt.label }}</option>
              }
            </select>
          </div>
          <div class="form-group flex-1">
            <label>Статус</label>
            <select [(ngModel)]="editForm().status" class="neo-input">
              @for (opt of statusOptions; track opt.value) {
              <option [value]="opt.value">{{ opt.label }}</option>
              }
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group flex-1">
            <label>Сумма</label>
            <input type="number" [(ngModel)]="editForm().amount" class="neo-input">
          </div>
          <div class="form-group flex-1">
            <label>Дата возврата</label>
            <input type="date" [(ngModel)]="editForm().dueDate" class="neo-input">
          </div>
        </div>
        <div class="form-group">
          <label>Заметка</label>
          <textarea [(ngModel)]="editForm().note" class="neo-input textarea"></textarea>
        </div>
        <div class="form-actions">
          <button class="btn cancel" (click)="cancelEdit()">Отмена</button>
          <button class="btn save" (click)="saveEdit()">Сохранить</button>
        </div>
      </div>
    </div>
    }

    <!-- Add Payment Form (Inline) -->
    @if (isAddingPayment()) {
    <div class="form-container neo-card">
      <h3 class="form-title">Транзакция по долгу</h3>
      <div class="neo-form">
        <div class="form-group">
          <label>Тип операции</label>
          <div class="payment-type-toggle">
            <button [class.active]="paymentForm().type === 'payment'" (click)="paymentForm().type = 'payment'">
              Выплата
            </button>
            <button [class.active]="paymentForm().type === 'charge'" (click)="paymentForm().type = 'charge'">
              Увеличение
            </button>
          </div>
        </div>
        <div class="form-group">
          <label>Сумма</label>
          <div class="amount-input-box">
            <span class="currency">{{ debt()?.currency }}</span>
            <input type="number" [(ngModel)]="paymentForm().amount" class="neo-input large">
          </div>
        </div>
        <div class="form-group">
          <label>Заметка (необязательно)</label>
          <input type="text" [(ngModel)]="paymentForm().note" class="neo-input" placeholder="Например: наличными">
        </div>
        <div class="form-actions">
          <button class="btn cancel" (click)="cancelAddPayment()">Отмена</button>
          <button class="btn save" (click)="savePayment()">Добавить</button>
        </div>
      </div>
    </div>
    }

    <!-- Timeline / History -->
    <div class="timeline-section">
      <h3 class="section-title">История событий</h3>
      <div class="timeline-container">
        @for (entry of timeline(); track (entry.date + entry.action)) {
        <div class="timeline-item neo-card">
          <div class="timeline-left">
            <div class="timeline-icon" [class.repayment]="entry.amount < 0" [class.charge]="entry.amount > 0">
              <mat-icon>{{ entry.amount < 0 ? 'remove' : 'add' }}</mat-icon>
            </div>
          </div>
          <div class="timeline-info">
            <div class="timeline-header">
              <span class="action-label">{{ entry.action }}</span>
              <span class="entry-amount" [class.negative]="entry.amount < 0" [class.positive]="entry.amount > 0">
                {{ formatAmount(absValue(entry.amount)) }}
              </span>
            </div>
            <div class="timeline-footer">
              <span class="entry-date">{{ entry.date | date:'d MMM yyyy, HH:mm' }}</span>
              @if (entry.note) {
              <span class="entry-note">{{ entry.note }}</span>
              }
            </div>
          </div>
        </div>
        } @empty {
        <div class="empty-state">
          <p>Нет событий в истории</p>
        </div>
        }
      </div>
    </div>
  </div>
  } @else {
  <div class="loading-state">
    <mat-spinner diameter="40"></mat-spinner>
    <p>Загрузка данных...</p>
  </div>
  }
</div>