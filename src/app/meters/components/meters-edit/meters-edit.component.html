<div class="meters-edit">
  <header class="meters-edit__header">
    <button mat-icon-button class="cancel-btn" routerLink="../list">
      <mat-icon>close</mat-icon>
    </button>
    <h2>{{ isEditMode ? 'Изменить показания' : 'Внести показания' }}</h2>
    <div style="width: 40px"></div>
  </header>

  <div class="meters-edit__content">

    <!-- Object Selection -->
    <div class="neo-form-group">
      <label>Объект</label>
      <input type="text" [ngModel]="form.objectName" (ngModelChange)="handleObjectChange($event)" list="objects-list"
        placeholder="Например: Дом" [disabled]="isEditMode" />
      <datalist id="objects-list">
        @for (object of objectOptions$ | async; track trackObject($index, object)) {
        <option [value]="object.name"></option>
        }
      </datalist>
    </div>

    @if (selectedResource; as resource) {
    <!-- Resource Selection -->
    <div class="neo-form-group">
      <label>Ресурс</label>
      <select [ngModel]="form.resourceId" (ngModelChange)="handleResourceChange($event)"
        [disabled]="isEditMode || resources.length <= 1">
        @for (res of resources; track res.id) {
        <option [value]="res.id">{{ res.name }} ({{ res.unit }})</option>
        }
      </select>
    </div>

    <!-- Date -->
    <div class="neo-form-group">
      <label>Дата снятия</label>
      <input type="date" [ngModel]="form.submittedAt" (ngModelChange)="handleDateChange($event)" />
    </div>

    <!-- Zones Inputs -->
    <h3>Показания</h3>
    @for (item of zones; track trackZone($index, item)) {
    <div class="zone-input-card">
      <div class="zone-input-card__header">
        <strong>{{ item.zone.name }}</strong>
        <small>{{ selectedResource?.unit }}</small>
      </div>

      <input type="number" class="neo-input" [ngModel]="item.current"
        (ngModelChange)="updateZoneValue(item.zone.id, $event)" placeholder="0" />

      @if (item.previous !== undefined) {
      <div class="zone-input-card__previous">
        Предыдущее: {{ item.previous }} • Расход: {{ item.consumption.toFixed(2) }}
      </div>
      }
    </div>
    }

    <!-- Summary -->
    @if (estimatedCost !== undefined) {
    <div class="summary-card">
      <h3>Расчётный итог</h3>

      @for (item of zones; track item.zone.id) {
      <div class="summary-row">
        <span>{{ item.zone.name }} ({{ item.consumption.toFixed(2) }} {{ selectedResource?.unit }})</span>
      </div>
      }

      <div class="summary-row total">
        <span>Итого к оплате</span>
        <span>{{ formatCurrency(estimatedCost, estimatedCurrency) }}</span>
      </div>
    </div>
    }

    } @else {
    <!-- No Resources State -->
    <div class="no-resources">
      <mat-icon>difference</mat-icon>
      <p>Для выбранного объекта пока нет счётчиков.</p>
      <a mat-stroked-button color="primary" routerLink="../resources" [queryParams]="{ object: form.objectName }">
        Настроить счётчики
      </a>
    </div>
    }

    <!-- Actions -->
    @if (selectedResource) {
    <button class="submit-btn" mat-ripple (click)="submit()" [disabled]="isSubmitDisabled">
      {{ isEditMode ? 'Сохранить изменения' : 'Внести показания' }}
    </button>
    }
  </div>
</div>