<div class="meters-edit-container">
  <!-- Minimal Header -->
  <div class="edit-header">
    <h2>{{ isEditMode ? 'Редактировать' : 'Новые показания' }}</h2>
  </div>

  <form (ngSubmit)="submit()" #meterForm="ngForm" class="meters-edit-form">

    <!-- Top Configuration Card -->
    <div class="config-card">
      <div class="input-group">
        <label>Объект</label>
        <div class="input-wrapper">
          <mat-icon>home</mat-icon>
          <input type="text" name="objectName" [ngModel]="form.objectName" (ngModelChange)="handleObjectChange($event)"
            list="meter-objects" placeholder="Например: Квартира" required class="neo-input" />
          <datalist id="meter-objects">
            <option *ngFor="let object of objectOptions$ | async; trackBy: trackObject" [value]="object"></option>
          </datalist>
        </div>
      </div>

      <div class="input-row">
        <div class="input-group flex-grow">
          <label>Ресурс</label>
          <div class="input-wrapper">
            <mat-icon>category</mat-icon>
            <select name="resourceId" [ngModel]="form.resourceId" (ngModelChange)="handleResourceChange($event)"
              [disabled]="!resources.length" required class="neo-select">
              <option *ngFor="let resource of resources" [value]="resource.id">
                {{ resource.name }}
              </option>
            </select>
          </div>
        </div>

        <div class="input-group">
          <label>Дата</label>
          <div class="input-wrapper">
            <input type="date" name="submittedAt" [ngModel]="form.submittedAt"
              (ngModelChange)="handleDateChange($event)" required class="neo-input date-input" />
          </div>
        </div>
      </div>
    </div>

    <!-- Zones / Readings -->
    <ng-container *ngIf="selectedResource; else noResourceSelected">
      <div class="zones-container">
        <div class="zone-card" *ngFor="let zone of zones; trackBy: trackZone">
          <div class="zone-header">
            <span class="zone-name">{{ zone.zone.name }}</span>
            <span class="zone-unit">{{ selectedResource.unit }}</span>
          </div>

          <!-- Large Input for Reading -->
          <div class="reading-input-wrapper">
            <input type="number" min="0" step="0.01" [name]="'zone-' + zone.zone.id"
              [ngModel]="form.values[zone.zone.id]" (ngModelChange)="updateZoneValue(zone.zone.id, $event)" required
              class="reading-input" placeholder="0" />
          </div>

          <!-- Stats (Previous & Delta) -->
          <div class="zone-stats">
            <div class="stat-item">
              <span class="stat-label">Было</span>
              <span class="stat-value">
                <ng-container *ngIf="zone.previous !== undefined; else noPrevious">
                  {{ zone.previous | number: '1.0-2' }}
                </ng-container>
              </span>
            </div>
            <div class="stat-divider"></div>
            <div class="stat-item">
              <span class="stat-label">Расход</span>
              <span class="stat-value delta" [class.has-consumption]="zone.consumption > 0">
                +{{ zone.consumption | number: '1.0-2' }}
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- Summary / Cost -->
      <div class="summary-card" *ngIf="estimatedCost !== undefined && estimatedCurrency">
        <div class="cost-row">
          <span>К оплате (расчёт):</span>
          <span class="total-cost">{{ formatCurrency(estimatedCost, estimatedCurrency) }}</span>
        </div>

        <div class="tariffs-info" *ngIf="activeTariffs.length">
          <div *ngFor="let tariff of activeTariffs" class="tariff-chip">
            {{ formatCurrency(tariff.price, tariff.currency) }} / {{ selectedResource.unit }}
          </div>
        </div>
      </div>

      <button mat-raised-button color="primary" type="submit" [disabled]="meterForm.invalid || isSubmitDisabled"
        class="submit-btn full-width">
        <mat-icon>check</mat-icon>
        {{ isEditMode ? 'Сохранить изменения' : 'Внести показания' }}
      </button>

    </ng-container>

    <ng-template #noPrevious>—</ng-template>

    <ng-template #noResourceSelected>
      <div class="empty-resource-state">
        <mat-icon>info</mat-icon>
        <p>Выберите объект и ресурс для ввода</p>
        <a routerLink="../resources" mat-button color="accent">Управление ресурсами</a>
      </div>
    </ng-template>

  </form>
</div>