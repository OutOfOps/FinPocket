<section class="meters-resources">
  <header class="meters-resources__header">
    <h2>Управление ресурсами</h2>
    <p>
      Настройка счётчиков и тарифов для коммунальных услуг.
    </p>
  </header>

  <div class="meters-resources__layout">
    <!-- List Section -->
    <section class="meters-resources__list">
      <h3>Ваши ресурсы</h3>

      @if (resources$(); as resources) {
      @if (resources.length) {
      @for (resource of resources; track trackResource($index, resource)) {
      <div class="resource-card">
        <div class="resource-header">
          <div class="resource-info">
            <div class="icon-box">
              <mat-icon>{{ resource.typeIcon }}</mat-icon>
            </div>
            <div class="names">
              <strong>{{ resource.entity.name }}</strong>
              <small>{{ resource.objectName }}</small>
            </div>
          </div>

          <button mat-icon-button [matMenuTriggerFor]="resourceMenu">
            <mat-icon>more_vert</mat-icon>
          </button>
          <mat-menu #resourceMenu="matMenu">
            <button mat-menu-item (click)="editResource(resource.entity, resource.objectName)">
              <mat-icon>edit</mat-icon>
              <span>Изменить</span>
            </button>
            <button mat-menu-item (click)="selectForTariffs(resource.entity)">
              <mat-icon>attach_money</mat-icon>
              <span>Тарифы</span>
            </button>
            <button mat-menu-item (click)="deleteResource(resource.entity)">
              <mat-icon>delete</mat-icon>
              <span>Удалить</span>
            </button>
          </mat-menu>
        </div>

        <div class="resource-details">
          <div>
            <span class="label">Тип</span>
            <span class="value">{{ resource.typeLabel }}</span>
          </div>
          <div>
            <span class="label">Зоны</span>
            <span class="value">{{ resource.zoneSummary }}</span>
          </div>
          <div>
            <span class="label">Оплата</span>
            <span class="value">
              @if (resource.isService && resource.fixedAmount !== undefined) {
              {{ formatCurrency(resource.fixedAmount, resource.fixedCurrency) }}
              } @else {
              {{ resource.pricingLabel }}
              }
            </span>
          </div>
        </div>
      </div>
      }
      } @else {
      <div class="meters-resources__empty">
        Нет добавленных ресурсов. Создайте новый ниже.
      </div>
      }
      }
    </section>

    <!-- Forms Section -->
    <section class="meters-resources__forms">

      <!-- Resource Form -->
      <form (ngSubmit)="saveResource()" #resourceFormRef="ngForm" class="meters-resources__form">
        <h3>{{ resourceForm.id ? 'Редактирование ресурса' : 'Новый ресурс' }}</h3>

        <label>
          Объект (Дом, Квартира)
          <input type="text" name="resourceObject" [ngModel]="resourceForm.objectName"
            (ngModelChange)="resourceForm.objectName = $event" list="resource-objects" required
            placeholder="Например: Дом, Офис" />
          <datalist id="resource-objects">
            @for (object of objectOptions$(); track trackObject($index, object)) {
            <option [value]="object.name"></option>
            }
          </datalist>
        </label>

        <label>
          Тип ресурса
          <select name="resourceType" [ngModel]="resourceForm.type" (ngModelChange)="onTypeChange($event)" required>
            @for (option of typeOptions; track option.type) {
            <option [value]="option.type">{{ option.label }}</option>
            }
          </select>
        </label>

        <label>
          Название счётчика
          <input type="text" name="resourceName" [(ngModel)]="resourceForm.name" required
            placeholder="Например: Счётчик на кухне" />
        </label>

        @if (resourceForm.type !== 'service') {
        <label>
          Единица измерения
          <input type="text" name="resourceUnit" [(ngModel)]="resourceForm.unit" required />
        </label>

        <label>
          Модель расчёта
          <select name="resourcePricing" [ngModel]="resourceForm.pricingModel"
            (ngModelChange)="onPricingModelChange($event)">
            @for (option of pricingModels; track option.value) {
            <option [value]="option.value">{{ option.label }}</option>
            }
          </select>
        </label>
        }

        @if (resourceForm.type === 'service') {
        <label>
          Стоимость услуги ({{ defaultCurrencyCode() }})
          <input type="number" min="0" step="0.01" name="resourceServiceAmount" [(ngModel)]="resourceForm.serviceAmount"
            required />
        </label>
        }

        @if (resourceForm.type === 'electricity' && resourceForm.pricingModel !== 'fixed') {
        <label>
          Зоны учёта
          <select name="resourceZones" [ngModel]="resourceForm.zoneTemplate"
            (ngModelChange)="onZoneTemplateChange($event)">
            @for (option of zoneTemplates; track option.value) {
            <option [value]="option.value">{{ option.label }}</option>
            }
          </select>
        </label>
        }

        @if (resourceForm.type !== 'service') {
        <div class="initial-values-section">
          <h4>Начальные показания</h4>
          <div class="initial-values-grid">
            @for (val of resourceForm.initialValues; track val.zoneId) {
            <label>
              {{ getZoneName(val.zoneId) }}
              <input type="number" [name]="'initialValue-' + val.zoneId" [(ngModel)]="val.value" min="0" step="0.01" />
            </label>
            }
          </div>
        </div>
        }

        <div class="meters-resources__form-actions">
          <button mat-button type="button" (click)="resetResourceForm()">Отмена</button>
          <button mat-raised-button color="primary" type="submit" [disabled]="resourceFormRef.invalid">
            {{ resourceForm.id ? 'Сохранить' : 'Добавить' }}
          </button>
        </div>
      </form>

      <!-- Tariff Form (Visible when resource selected) -->
      @if (selectedResource; as resource) {
      <section class="meters-resources__tariffs">
        <h3>Тарифы: {{ resource.name }}</h3>

        @if (resource.type === 'service') {
        <div class="meters-resources__empty">
          Услуга с фиксированной стоимостью настраивается в параметрах ресурса.
        </div>
        } @else {
        <form (ngSubmit)="saveTariff()" #tariffFormRef="ngForm" class="meters-resources__tariff-form">
          <div class="meters-resources__tariff-grid">
            <label>
              Зона
              <select name="tariffZone" [(ngModel)]="tariffForm.zoneId">
                @for (option of zoneOptions; track option.id) {
                <option [ngValue]="option.id">{{ option.label }}</option>
                }
              </select>
            </label>

            <label>
              Стоимость
              <input type="number" min="0" step="0.01" name="tariffPrice" [(ngModel)]="tariffForm.price" required />
            </label>

            <label>
              Валюта
              <input type="text" name="tariffCurrency" [(ngModel)]="tariffForm.currency" required
                [placeholder]="defaultCurrencyCode()" />
            </label>

            <label>
              Действует с
              <input type="date" name="tariffEffective" [(ngModel)]="tariffForm.effectiveFrom" required />
            </label>
          </div>

          <label>
            Комментарий
            <input type="text" name="tariffDescription" [(ngModel)]="tariffForm.description"
              placeholder="Например: тариф с 1 января" />
          </label>

          <div class="meters-resources__form-actions">
            <button mat-raised-button color="accent" type="submit" [disabled]="tariffFormRef.invalid">
              Добавить тариф
            </button>
          </div>
        </form>

        <h4>История тарифов</h4>
        @if (tariffHistory.length) {
        <ul class="meters-resources__tariff-history">
          @for (tariff of tariffHistory; track trackTariff($index, tariff)) {
          <li>
            <div>
              <strong>{{ zoneName(tariff.zoneId) }}</strong>
              <span>{{ formatCurrency(tariff.price, tariff.currency) }} (с {{ tariff.effectiveFrom | date: 'd MMM y'
                }})</span>
              @if (tariff.description) {
              <small>{{ tariff.description }}</small>
              }
            </div>
            <button mat-icon-button color="warn" (click)="removeTariff(tariff)">
              <mat-icon>delete</mat-icon>
            </button>
          </li>
          }
        </ul>
        } @else {
        <p class="meters-resources__empty">Нет записей тарифов.</p>
        }
        }
      </section>
      }

    </section>
  </div>
</section>