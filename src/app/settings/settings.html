<div class="settings-view">
  <header class="settings-header">
    <h1>Настройки</h1>
  </header>

  <div class="settings-container">

    <!-- Appearance Section -->
    <section class="settings-section">
      <h3 class="section-title">Внешний вид</h3>

      <div class="setting-item">
        <div class="setting-content">
          <span class="setting-label">Тема оформления</span>
          <span class="setting-desc">{{ theme() === 'dark' ? 'Тёмная' : 'Светлая' }}</span>
        </div>
        <div class="theme-toggle-wrapper">
          <button class="theme-btn" [class.active]="theme() === 'dark'" (click)="setTheme('dark')">
            <mat-icon>nights_stay</mat-icon>
          </button>
          <button class="theme-btn" [class.active]="theme() === 'light'" (click)="setTheme('light')">
            <mat-icon>wb_sunny</mat-icon>
          </button>
        </div>
      </div>

      <div class="setting-item column">
        <span class="setting-label">Акцентный цвет</span>
        <div class="colors-row">
          <button type="button" class="color-circle acc-purple" [class.active]="accent() === 'purple'"
            (click)="setAccent('purple')" mat-ripple></button>
          <button type="button" class="color-circle acc-blue" [class.active]="accent() === 'blue'"
            (click)="setAccent('blue')" mat-ripple></button>
          <button type="button" class="color-circle acc-green" [class.active]="accent() === 'green'"
            (click)="setAccent('green')" mat-ripple></button>
          <button type="button" class="color-circle acc-orange" [class.active]="accent() === 'orange'"
            (click)="setAccent('orange')" mat-ripple></button>
        </div>
      </div>
    </section>

    <!-- Accounts Section -->
    <section class="settings-section">
      <div class="section-header">
        <h3 class="section-title">Счета</h3>
      </div>

      <div class="accounts-list">
        <div class="account-item" *ngFor="let acc of accounts()" [class.editing]="editingAccountId === acc.id">

          <!-- View Mode -->
          <ng-container *ngIf="editingAccountId !== acc.id">
            <div class="account-icon-wrapper" [class.metal]="acc.type === 'metal'">
              <mat-icon>{{ getAccountIcon(acc.type) }}</mat-icon>
            </div>

            <div class="account-info">
              <span class="account-name">{{ acc.name }}</span>
              <span class="account-detail" *ngIf="acc.type === 'bank'">{{ acc.bankName }}</span>
              <span class="account-detail" *ngIf="acc.type === 'metal'">{{ acc.metalName }}</span>
              <span class="account-balance">{{ acc.initialBalance | number:'1.2-2' }} {{ acc.currencyCode }}</span>
            </div>

            <div class="account-actions">
              <button mat-icon-button (click)="startAccountEdit(acc)">
                <mat-icon>edit</mat-icon>
              </button>
              <button mat-icon-button color="warn" (click)="removeAccount(acc.id)">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </ng-container>

          <!-- Edit Mode -->
          <div class="account-edit-form" *ngIf="editingAccountId === acc.id">
            <div class="edit-row">
              <input [(ngModel)]="editingAccount.name" placeholder="Название" class="neo-input small">
              <select [(ngModel)]="editingAccount.type" class="neo-input small">
                <option value="cash">Наличные</option>
                <option value="bank">Банк</option>
                <option value="metal">Металлол/Драг.</option>
              </select>
            </div>
            <div class="edit-row">
              <input *ngIf="editingAccount.type === 'bank'" [(ngModel)]="editingAccount.bankName"
                placeholder="Название банка" class="neo-input">
              <input *ngIf="editingAccount.type === 'metal'" [(ngModel)]="editingAccount.metalName"
                placeholder="Название металла" class="neo-input">
            </div>
            <div class="edit-row">
              <input type="number" [(ngModel)]="editingAccount.initialBalance" placeholder="Баланс"
                class="neo-input small">
              <select [(ngModel)]="editingAccount.currencyCode" class="neo-input small">
                <option *ngFor="let c of currencies()" [value]="c.code">{{ c.code }}</option>
              </select>
            </div>
            <div class="edit-actions">
              <button mat-button (click)="cancelAccountEdit()">Отмена</button>
              <button mat-raised-button color="primary" (click)="saveAccountEdit()">Сохранить</button>
            </div>
          </div>

        </div>
      </div>

      <!-- Add Account Form -->
      <div class="add-account-form">
        <div class="form-row">
          <input [(ngModel)]="newAccount.name" placeholder="Новый счет" class="neo-input">
          <select [(ngModel)]="newAccount.type" class="neo-input small-select">
            <option value="cash">Наличные</option>
            <option value="bank">Банк</option>
            <option value="metal">Метал.</option>
          </select>
        </div>

        <div class="form-row" *ngIf="newAccount.type === 'bank' || newAccount.type === 'metal'">
          <input *ngIf="newAccount.type === 'bank'" [(ngModel)]="newAccount.bankName" placeholder="Название банка"
            class="neo-input">
          <input *ngIf="newAccount.type === 'metal'" [(ngModel)]="newAccount.metalName" placeholder="Название металла"
            class="neo-input">
        </div>

        <div class="form-row">
          <input type="number" [(ngModel)]="newAccount.initialBalance" placeholder="Нач. баланс" class="neo-input">
          <select [(ngModel)]="newAccount.currencyCode" class="neo-input small-select" *ngIf="currencies() as list">
            <option *ngFor="let c of list" [value]="c.code">{{ c.code }}</option>
          </select>
        </div>

        <button mat-stroked-button color="primary" class="add-btn" (click)="addAccount()" [disabled]="!canAddAccount()">
          <mat-icon>add</mat-icon> Добавить счет
        </button>
      </div>

    </section>

    <!-- Currencies Section -->
    <section class="settings-section">
      <div class="section-header">
        <h3 class="section-title">Валюты</h3>
      </div>

      <div class="currencies-list">
        <div class="currency-item" *ngFor="let currency of currencies(); trackBy: trackCurrency">
          <div class="currency-info">
            <span class="currency-code">{{ currency.code }}</span>
            <span class="currency-name">{{ currency.name }}</span>
          </div>

          <div class="currency-actions">
            <!-- Base Currency Indicator -->
            <div *ngIf="currency.id === defaultCurrency()" class="base-badge">
              <mat-icon>star</mat-icon>
              <span>Базовая</span>
            </div>

            <!-- Editable Rate for Non-Base -->
            <ng-container *ngIf="currency.id !== defaultCurrency()">
              <button mat-icon-button (click)="loadRateFor(currency.id)" title="Обновить курс (НБУ)">
                <mat-icon class="sync-icon">sync</mat-icon>
              </button>

              <div class="rate-editor">
                <input type="number" [ngModel]="getRelativeRate(currency)" (change)="updateRate(currency, $event)"
                  step="0.0001" class="rate-input">
              </div>

              <button mat-icon-button (click)="setDefaultCurrency(currency.id)" title="Сделать основной">
                <mat-icon>star_border</mat-icon>
              </button>

              <button mat-icon-button color="warn" (click)="removeCurrency(currency.id)">
                <mat-icon>delete</mat-icon>
              </button>
            </ng-container>
          </div>
        </div>
      </div>

      <!-- Add Currency Form -->
      <form class="add-currency-form" (ngSubmit)="addCurrency()">
        <!-- Custom Select for available NBU codes -->
        <div class="nbu-select-wrapper">
          <select [ngModel]="newCurrency.code" (ngModelChange)="onNbuCodeSelect($event)" name="nbuSelect"
            class="neo-input small">
            <option value="" disabled selected>Код</option>
            <option *ngFor="let item of nbuList" [value]="item.code">{{ item.code }}</option>
          </select>
        </div>

        <input type="text" [(ngModel)]="newCurrency.name" name="name" placeholder="Название" required
          class="neo-input medium">
        <input type="number" [(ngModel)]="newCurrency.rate" name="rate" placeholder="Курс" required step="0.01"
          class="neo-input small">
        <button mat-icon-button type="submit" [disabled]="!canAddCurrency()" color="primary">
          <mat-icon>add_circle</mat-icon>
        </button>
      </form>
    </section>

    <!-- Data & Sync -->
    <section class="settings-section">
      <h3 class="section-title">Синхронизация</h3>

      <div class="setting-item column">
        <span class="setting-label">Google Drive API</span>
        <input type="text" [ngModel]="syncSettings.getGoogleDriveClientId()"
          (ngModelChange)="syncSettings.setGoogleDriveClientId($event)" placeholder="Client ID" class="neo-input">
        <input type="password" [ngModel]="syncSettings.getGoogleDriveClientSecret()"
          (ngModelChange)="syncSettings.setGoogleDriveClientSecret($event)" placeholder="Client Secret"
          class="neo-input">
      </div>

      <div class="actions-row">
        <button mat-stroked-button (click)="downloadBackup()" [disabled]="isExportingData">
          <mat-icon>download</mat-icon> Скачать бэкап
        </button>
        <button mat-stroked-button (click)="triggerImport()" [disabled]="isImportingData">
          <mat-icon>upload</mat-icon> Восстановить
        </button>
        <input type="file" id="backup-file-input" (change)="onFileSelected($event)" accept=".json"
          style="display: none" />
      </div>
    </section>

    <!-- Danger Zone -->
    <section class="settings-section danger">
      <button mat-button color="warn" (click)="openResetDataDialog()" [disabled]="isResetting" class="reset-btn">
        <mat-icon>delete_forever</mat-icon>
        Сбросить все данные
      </button>
    </section>

  </div>
</div>