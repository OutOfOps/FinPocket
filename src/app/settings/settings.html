<div class="settings-view">
  <header class="settings-header">
    <h1>Настройки</h1>
  </header>

  <div class="settings-container">

    <!-- Appearance Section -->
    <section class="settings-section">
      <h3 class="section-title">Внешний вид</h3>

      <div class="setting-item">
        <div class="setting-content">
          <span class="setting-label">Тема оформления</span>
          <span class="setting-desc">{{ theme() === 'dark' ? 'Тёмная' : 'Светлая' }}</span>
        </div>
        <div class="theme-toggle-wrapper">
          <button class="theme-btn" [class.active]="theme() === 'dark'" (click)="setTheme('dark')">
            <mat-icon>nights_stay</mat-icon>
          </button>
          <button class="theme-btn" [class.active]="theme() === 'light'" (click)="setTheme('light')">
            <mat-icon>wb_sunny</mat-icon>
          </button>
        </div>
      </div>

      <div class="setting-item column">
        <span class="setting-label">Акцентный цвет</span>
        <div class="colors-row">
          <button type="button" class="color-circle acc-purple" [class.active]="accent() === 'purple'"
            (click)="setAccent('purple')" mat-ripple></button>
          <button type="button" class="color-circle acc-blue" [class.active]="accent() === 'blue'"
            (click)="setAccent('blue')" mat-ripple></button>
          <button type="button" class="color-circle acc-green" [class.active]="accent() === 'green'"
            (click)="setAccent('green')" mat-ripple></button>
          <button type="button" class="color-circle acc-orange" [class.active]="accent() === 'orange'"
            (click)="setAccent('orange')" mat-ripple></button>
        </div>
      </div>
    </section>

    <!-- Accounts Section -->
    <section class="settings-section">
      <div class="section-header">
        <h3 class="section-title">Счета</h3>
      </div>

      <div class="accounts-list">
        @for (acc of accounts(); track acc.id) {
        <div class="account-item" [class.editing]="editingAccountId === acc.id">

          <!-- View Mode -->
          @if (editingAccountId !== acc.id) {
          <div class="account-icon-wrapper" [class.metal]="acc.type === 'metal'">
            <mat-icon>{{ acc.type | accountIcon }}</mat-icon>
          </div>

          <div class="account-info">
            <span class="account-name">{{ acc.name }}</span>
            @if (acc.type === 'bank') {
            <span class="account-detail">{{ acc.bankName }}</span>
            }
            @if (acc.type === 'metal') {
            <span class="account-detail">{{ acc.metalName }}</span>
            }
            <span class="account-balance">{{ acc.initialBalance | number:'1.2-10' }} {{ acc.type === 'metal' ? 'г ' +
              acc.currencyCode : acc.currencyCode }}</span>
            @if (acc.includeInTotal === false) {
            <mat-icon class="ignored-icon" title="Не учитывается в общем балансе">visibility_off</mat-icon>
            }
          </div>

          <div class="account-actions">
            <button mat-icon-button (click)="startAccountEdit(acc)">
              <mat-icon>edit</mat-icon>
            </button>
            <button mat-icon-button color="warn" (click)="removeAccount(acc.id)">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
          }

          <!-- Edit Mode -->
          @if (editingAccountId === acc.id) {
          <div class="account-edit-form">
            <div class="edit-row">
              <input [(ngModel)]="editingAccount.name" placeholder="Название" class="neo-input small">
              <select [(ngModel)]="editingAccount.type" class="neo-input small">
                <option value="cash">Наличные</option>
                <option value="bank">Банк</option>
                <option value="metal">Метал/Драг.</option>
              </select>
            </div>
            <div class="edit-row">
              @if (editingAccount.type === 'bank') {
              <input [(ngModel)]="editingAccount.bankName" placeholder="Название банка" class="neo-input">
              }

              @if (editingAccount.type === 'metal') {
              <!-- Metal Name as Select from NBU -->
              <select [(ngModel)]="editingAccount.metalName" class="neo-input" placeholder="Выберите металл">
                <option value="" disabled selected>Выберите металл...</option>
                @for (m of nbuMetals; track m.txt) {
                <option [value]="m.txt">
                  {{ m.txt }} ({{ m.code }})
                </option>
                }
              </select>
              }
            </div>
            <div class="edit-row">
              <input type="number" [(ngModel)]="editingAccount.initialBalance" placeholder="Баланс"
                class="neo-input small">
              <select [(ngModel)]="editingAccount.currencyCode" class="neo-input small">
                @for (c of currencies(); track c.code) {
                <option [value]="c.code">{{ c.code }}</option>
                }
              </select>
            </div>
            <div class="edit-row">
              <label class="setting-checkbox">
                <input type="checkbox" [(ngModel)]="editingAccount.includeInTotal">
                Учитывать в общем балансе
              </label>
            </div>
            <div class="edit-actions">
              <button mat-button (click)="cancelAccountEdit()">Отмена</button>
              <button mat-raised-button color="primary" (click)="saveAccountEdit()">Сохранить</button>
            </div>
          </div>
          }

        </div>
        }
      </div>

      <!-- Add Account Form -->
      <div class="add-account-form">
        <div class="form-row">
          <input [(ngModel)]="newAccount.name" placeholder="Новый счет" class="neo-input">
          <select [(ngModel)]="newAccount.type" class="neo-input small-select">
            <option value="cash">Наличные</option>
            <option value="bank">Банк</option>
            <option value="metal">Метал.</option>
          </select>
        </div>

        @if (newAccount.type === 'bank' || newAccount.type === 'metal') {
        <div class="form-row">
          @if (newAccount.type === 'bank') {
          <input [(ngModel)]="newAccount.bankName" placeholder="Название банка" class="neo-input">
          }

          @if (newAccount.type === 'metal') {
          <select [ngModel]="newAccount.metalName"
            (ngModelChange)="newAccount.metalName=$event; onMetalSelect($event, 'new')" class="neo-input"
            placeholder="Выберите металл">
            @for (m of nbuMetals; track m.txt) {
            <option [value]="m.txt">
              {{ m.txt }} ({{ m.code }})
            </option>
            }
          </select>
          }
        </div>
        }

        <div class="form-row">
          <input type="number" [(ngModel)]="newAccount.initialBalance" placeholder="Нач. баланс" class="neo-input">

          @if (newAccount.type !== 'metal') {
          <select [(ngModel)]="newAccount.currencyCode" class="neo-input small-select">
            @for (c of currencies(); track c.code) {
            <option [value]="c.code">{{ c.code }}</option>
            }
          </select>
          }
        </div>

        <div class="form-row">
          <label class="setting-checkbox">
            <input type="checkbox" [(ngModel)]="newAccount.includeInTotal">
            Учитывать в общем балансе
          </label>
        </div>

        <button mat-stroked-button color="primary" class="add-btn" (click)="addAccount()" [disabled]="!canAddAccount()">
          <mat-icon>add</mat-icon> Добавить счет
        </button>
      </div>

    </section>

    <!-- Currencies Section -->
    <section class="settings-section">
      <div class="section-header">
        <h3 class="section-title">Валюты</h3>
      </div>

      <div class="currencies-list">
        @for (currency of currencies(); track currency.id) {
        <div class="currency-item">
          <div class="currency-info">
            <span class="currency-code">{{ currency.code }}</span>
            <span class="currency-name">{{ currency.name }}</span>
          </div>

          <div class="currency-actions">
            <!-- Base Currency Indicator -->
            @if (currency.id === defaultCurrency()) {
            <div class="base-badge">
              <mat-icon>star</mat-icon>
              <span>Базовая</span>
            </div>
            }

            <!-- Editable Rate for Non-Base -->
            @if (currency.id !== defaultCurrency()) {
            <ng-container>
              <button mat-icon-button (click)="loadRateFor(currency.id)" title="Обновить курс (НБУ)">
                <mat-icon class="sync-icon">sync</mat-icon>
              </button>

              <div class="rate-editor">
                <input type="number" [ngModel]="getRelativeRate(currency)" (change)="updateRate(currency, $event)"
                  step="0.0001" class="rate-input">
              </div>

              <button mat-icon-button (click)="setDefaultCurrency(currency.id)" title="Сделать основной">
                <mat-icon>star_border</mat-icon>
              </button>

              <button mat-icon-button color="warn" (click)="removeCurrency(currency.id)">
                <mat-icon>delete</mat-icon>
              </button>
            </ng-container>
            }
          </div>
        </div>
        }
      </div>

      <!-- Add Currency Form -->
      <form class="add-currency-form" (ngSubmit)="addCurrency()">
        <!-- Custom Select for available NBU codes -->
        <div class="nbu-select-wrapper">
          <select [ngModel]="newCurrency.code" (ngModelChange)="onNbuCodeSelect($event)" name="nbuSelect"
            class="neo-input small">
            <option value="" disabled selected>Код</option>
            @for (item of nbuList; track item.code) {
            <option [value]="item.code">{{ item.code }}</option>
            }
          </select>
        </div>

        <input type="text" [(ngModel)]="newCurrency.name" name="name" placeholder="Название" required
          class="neo-input medium">
        <input type="number" [(ngModel)]="newCurrency.rate" name="rate" placeholder="Курс" required step="0.01"
          class="neo-input small">
        <button mat-icon-button type="submit" [disabled]="!canAddCurrency()" color="primary">
          <mat-icon>add_circle</mat-icon>
        </button>
      </form>
    </section>

    <!-- Data & Sync -->
    <section class="settings-section">
      <div class="section-header">
        <h3 class="section-title">Синхронизация</h3>
        <button mat-icon-button routerLink="/sync" title="Детальное управление">
          <mat-icon>open_in_new</mat-icon>
        </button>
      </div>

      <div class="setting-item column">
        <label class="setting-label">Google Drive API</label>
        <div class="api-inputs">
          <input type="text" [ngModel]="syncSettings.getGoogleDriveClientId()"
            (ngModelChange)="syncSettings.setGoogleDriveClientId($event)" placeholder="Client ID" class="neo-input">
        </div>
      </div>

      <div class="setting-item column">
        <label class="setting-label">Мастер-пароль (Ключ шифрования)</label>
        <div class="password-input-row">
          <input type="password" [ngModel]="masterPassword()" (ngModelChange)="setMasterPassword($event)"
            placeholder="Ваш секретный ключ" class="neo-input">
          <mat-icon class="hint-icon"
            matTooltip="Пароль хранится локально и используется для автоматической синхронизации">info_outline</mat-icon>
        </div>
      </div>

      <div class="sync-actions" style="margin-top: 1.5rem; display: flex; justify-content: center;">
        <a mat-button color="primary" routerLink="sync">Детальные настройки синхронизации</a>
      </div>
      <div class="setting-item">
        <div class="setting-content">
          <span class="setting-label">Автоматическая синхронизация</span>
          <span class="setting-desc">Периодическая проверка изменений</span>
        </div>
        <mat-slide-toggle [checked]="autoSyncEnabled()"
          (change)="setAutoSyncEnabled($event.checked)"></mat-slide-toggle>
      </div>

      @if (autoSyncEnabled()) {
      <div class="setting-item column">
        <label class="setting-label">Интервал проверки (минуты)</label>
        <div class="slider-row">
          <mat-slider min="5" max="1440" step="5" discrete>
            <input matSliderThumb [ngModel]="syncInterval()" (ngModelChange)="setSyncInterval($event)">
          </mat-slider>
          <span class="value-label">{{ syncInterval() }} мин.</span>
        </div>
      </div>
      }

      <div class="setting-item column">
        <label class="setting-label">Срок хранения копий (дней)</label>
        <div class="slider-row">
          <mat-slider min="0" max="365" step="1" discrete>
            <input matSliderThumb [ngModel]="retentionDays()" (ngModelChange)="setRetentionDays($event)">
          </mat-slider>
          <span class="value-label">{{ retentionDays() === 0 ? 'Бесконечно' : retentionDays() + ' дн.' }}</span>
        </div>
      </div>

      <div class="actions-row">
        <button mat-stroked-button (click)="downloadBackup()" [disabled]="isExportingData">
          <mat-icon>download</mat-icon> Файл
        </button>
        <button mat-stroked-button (click)="triggerImport()" [disabled]="isImportingData">
          <mat-icon>upload</mat-icon> Из файла
        </button>
        <input type="file" id="backup-file-input" (change)="onFileSelected($event)" accept=".json"
          style="display: none" />
      </div>
    </section>

    <section class="settings-section danger">
      <button mat-button color="warn" (click)="openResetDataDialog()" [disabled]="isResetting" class="reset-btn">
        <mat-icon>delete_forever</mat-icon>
        Сбросить все данные
      </button>
    </section>

    <!-- About & App Info -->
    <section class="settings-section app-info-section">
      <div class="app-version-info">
        <span class="version-label">Версия приложения</span>
        <span class="version-badge">{{ appVersion }}</span>
      </div>

      <div class="app-actions">
        <button mat-flat-button color="accent" (click)="checkUpdate()" [disabled]="isCheckingUpdates">
          <mat-icon [class.spinning]="isCheckingUpdates">refresh</mat-icon>
          Проверить обновление
        </button>

        <button mat-button routerLink="about" class="about-link">
          <mat-icon>info_outline</mat-icon>
          О программе
        </button>
      </div>
    </section>

  </div>
</div>