<div class="settings-view">
  <header class="settings-header">
    <h1>Настройки</h1>
  </header>

  <div class="settings-container">

    <!-- Appearance Section -->
    <section class="settings-section">
      <h3 class="section-title">Внешний вид</h3>

      <div class="setting-item">
        <div class="setting-content">
          <span class="setting-label">Тема оформления</span>
          <span class="setting-desc">{{ theme() === 'dark' ? 'Тёмная' : 'Светлая' }}</span>
        </div>
        <div class="theme-toggle-wrapper">
          <button class="theme-btn" [class.active]="theme() === 'dark'" (click)="setTheme('dark')">
            <mat-icon>nights_stay</mat-icon>
          </button>
          <button class="theme-btn" [class.active]="theme() === 'light'" (click)="setTheme('light')">
            <mat-icon>wb_sunny</mat-icon>
          </button>
        </div>
      </div>

      <div class="setting-item column">
        <span class="setting-label">Акцентный цвет</span>
        <div class="colors-row">
          <button type="button" class="color-circle acc-purple" [class.active]="accent() === 'purple'"
            (click)="setAccent('purple')" mat-ripple></button>
          <button type="button" class="color-circle acc-blue" [class.active]="accent() === 'blue'"
            (click)="setAccent('blue')" mat-ripple></button>
          <button type="button" class="color-circle acc-green" [class.active]="accent() === 'green'"
            (click)="setAccent('green')" mat-ripple></button>
          <button type="button" class="color-circle acc-orange" [class.active]="accent() === 'orange'"
            (click)="setAccent('orange')" mat-ripple></button>
        </div>
      </div>
    </section>

    <!-- Currencies Section -->
    <section class="settings-section">
      <div class="section-header">
        <h3 class="section-title">Валюты</h3>
        <button mat-icon-button (click)="loadNbuRates()" [disabled]="isLoadingRates" title="Загрузить курсы НБУ">
          <mat-icon [class.spin]="isLoadingRates">sync</mat-icon>
        </button>
      </div>

      <div class="currencies-list">
        <div class="currency-item" *ngFor="let currency of currencies(); trackBy: trackCurrency">
          <div class="currency-info">
            <span class="currency-code">{{ currency.code }}</span>
            <span class="currency-name">{{ currency.name }}</span>
          </div>

          <div class="currency-actions">
            <!-- Base Currency Indicator -->
            <div *ngIf="currency.id === defaultCurrency()" class="base-badge">
              <mat-icon>star</mat-icon>
              <span>Базовая</span>
            </div>

            <!-- Editable Rate for Non-Base -->
            <ng-container *ngIf="currency.id !== defaultCurrency()">
              <div class="rate-editor">
                <input type="number" [ngModel]="getRelativeRate(currency)" (change)="updateRate(currency, $event)"
                  step="0.0001" class="rate-input">
              </div>

              <button mat-icon-button (click)="setDefaultCurrency(currency.id)" title="Сделать основной">
                <mat-icon>star_border</mat-icon>
              </button>

              <button mat-icon-button color="warn" (click)="removeCurrency(currency.id)">
                <mat-icon>delete</mat-icon>
              </button>
            </ng-container>
          </div>
        </div>
      </div>

      <!-- Add Currency Form -->
      <form class="add-currency-form" (ngSubmit)="addCurrency()">
        <input type="text" [(ngModel)]="newCurrency.code" name="code" placeholder="Код (USD)" required maxlength="3"
          class="neo-input small">
        <input type="text" [(ngModel)]="newCurrency.name" name="name" placeholder="Название" required
          class="neo-input medium">
        <input type="number" [(ngModel)]="newCurrency.rate" name="rate" placeholder="Курс" required step="0.01"
          class="neo-input small">
        <button mat-icon-button type="submit" [disabled]="!canAddCurrency()" color="primary">
          <mat-icon>add_circle</mat-icon>
        </button>
      </form>
    </section>

    <!-- Data & Sync -->
    <section class="settings-section">
      <h3 class="section-title">Синхронизация</h3>

      <div class="setting-item column">
        <span class="setting-label">Google Drive API</span>
        <input type="text" [ngModel]="syncSettings.getGoogleDriveClientId()"
          (ngModelChange)="syncSettings.setGoogleDriveClientId($event)" placeholder="Client ID" class="neo-input">
        <input type="password" [ngModel]="syncSettings.getGoogleDriveClientSecret()"
          (ngModelChange)="syncSettings.setGoogleDriveClientSecret($event)" placeholder="Client Secret"
          class="neo-input">
      </div>

      <div class="actions-row">
        <button mat-stroked-button (click)="downloadBackup()" [disabled]="isExportingData">
          <mat-icon>download</mat-icon> Скачать бэкап
        </button>
        <button mat-stroked-button (click)="triggerImport()" [disabled]="isImportingData">
          <mat-icon>upload</mat-icon> Восстановить
        </button>
        <input type="file" id="backup-file-input" (change)="onFileSelected($event)" accept=".json"
          style="display: none" />
      </div>
    </section>

    <!-- Danger Zone -->
    <section class="settings-section danger">
      <button mat-button color="warn" (click)="openResetDataDialog()" [disabled]="isResetting" class="reset-btn">
        <mat-icon>delete_forever</mat-icon>
        Сбросить все данные
      </button>
    </section>

  </div>
</div>